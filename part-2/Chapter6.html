<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>

<link href='https://fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic&subset=latin-ext' rel='stylesheet' type='text/css' /><link href='https://fonts.googleapis.com/css?family=Lato:900,300&subset=latin-ext' rel='stylesheet' type='text/css' /><style type='text/css'>html {overflow-x: initial !important;}:root { --mermaid-theme: default; --mermaid-sequence-numbers: off; --mermaid-flowchart-curve: linear; --mermaid--gantt-left-padding: 75; --sequence-theme: simple; }
.privacy { display: none; }


:root { --bg-color: #ffffff; --text-color: #333333; --select-text-bg-color: #B5D6FC; --select-text-font-color: auto; --monospace: "Lucida Console",Consolas,"Courier",monospace; --title-bar-height: 20px; }
.mac-os-11 { --title-bar-height: 28px; }
html { font-size: 14px; background-color: var(--bg-color); color: var(--text-color); font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; }
h1, h2, h3, h4, h5 { white-space: pre-wrap; }
body { margin: 0px; padding: 0px; height: auto; inset: 0px; font-size: 1rem; line-height: 1.428571; overflow-x: hidden; background: inherit; }
iframe { margin: auto; }
a.url { word-break: break-all; }
a:active, a:hover { outline: 0px; }
.in-text-selection, ::selection { text-shadow: none; background: var(--select-text-bg-color); color: var(--select-text-font-color); }
#write { margin: 0px auto; height: auto; width: inherit; word-break: normal; overflow-wrap: break-word; position: relative; white-space: normal; overflow-x: visible; padding-top: 36px; }
#write.first-line-indent p { text-indent: 2em; }
#write.first-line-indent li p, #write.first-line-indent p * { text-indent: 0px; }
#write.first-line-indent li { margin-left: 2em; }
.for-image #write { padding-left: 8px; padding-right: 8px; }
body.typora-export { padding-left: 30px; padding-right: 30px; }
.typora-export .footnote-line, .typora-export li, .typora-export p { white-space: pre-wrap; }
.typora-export .task-list-item input { pointer-events: none; }
@media screen and (max-width: 500px) {
  body.typora-export { padding-left: 0px; padding-right: 0px; }
  #write { padding-left: 20px; padding-right: 20px; }
}
#write li > figure:last-child { margin-bottom: 0.5rem; }
#write ol, #write ul { position: relative; }
img { max-width: 100%; vertical-align: middle; image-orientation: from-image; }
button, input, select, textarea { color: inherit; font-style: inherit; font-variant-caps: inherit; font-weight: inherit; font-stretch: inherit; font-size: inherit; line-height: inherit; font-family: inherit; font-size-adjust: inherit; font-kerning: inherit; font-variant-alternates: inherit; font-variant-ligatures: inherit; font-variant-numeric: inherit; font-variant-east-asian: inherit; font-variant-position: inherit; font-variant-emoji: inherit; font-feature-settings: inherit; font-optical-sizing: inherit; font-variation-settings: inherit; }
input[type="checkbox"], input[type="radio"] { line-height: normal; padding: 0px; }
*, ::after, ::before { box-sizing: border-box; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p, #write pre { width: inherit; position: relative; }
#write svg h1, #write svg h2, #write svg h3, #write svg h4, #write svg h5, #write svg h6, #write svg p { position: static; }
p { line-height: inherit; }
h1, h2, h3, h4, h5, h6 { break-after: avoid-page; break-inside: avoid; orphans: 4; }
p { orphans: 4; }
h1 { font-size: 2rem; }
h2 { font-size: 1.8rem; }
h3 { font-size: 1.6rem; }
h4 { font-size: 1.4rem; }
h5 { font-size: 1.2rem; }
h6 { font-size: 1rem; }
.md-math-block, .md-rawblock, h1, h2, h3, h4, h5, h6, p { margin-top: 1rem; margin-bottom: 1rem; }
.hidden { display: none; }
.md-blockmeta { color: rgb(204, 204, 204); font-weight: 700; font-style: italic; }
a { cursor: pointer; }
sup.md-footnote { padding: 2px 4px; background-color: rgba(238, 238, 238, 0.7); color: rgb(85, 85, 85); border-radius: 4px; cursor: pointer; }
sup.md-footnote a, sup.md-footnote a:hover { color: inherit; text-transform: inherit; text-decoration: inherit; }
#write input[type="checkbox"] { cursor: pointer; width: inherit; height: inherit; }
figure { overflow-x: auto; margin: 1.2em 0px; max-width: calc(100% + 16px); padding: 0px; }
figure > table { margin: 0px; }
thead, tr { break-inside: avoid; break-after: auto; }
thead { display: table-header-group; }
table { border-collapse: collapse; border-spacing: 0px; width: 100%; overflow: auto; break-inside: auto; text-align: left; }
table.md-table td { min-width: 32px; }
.CodeMirror-gutters { border-right-width: 0px; border-right-style: none; border-right-color: currentcolor; background-color: inherit; }
.CodeMirror-linenumber { -webkit-user-select: none; }
.CodeMirror { text-align: left; }
.CodeMirror-placeholder { opacity: 0.3; }
.CodeMirror pre { padding: 0px 4px; }
.CodeMirror-lines { padding: 0px; }
div.hr:focus { cursor: none; }
#write pre { white-space: pre-wrap; }
#write.fences-no-line-wrapping pre { white-space: pre; }
#write pre.ty-contain-cm { white-space: normal; }
.CodeMirror-gutters { margin-right: 4px; }
.md-fences { font-size: 0.9rem; display: block; break-inside: avoid; text-align: left; overflow: visible; white-space: pre; background: inherit; position: relative !important; }
.md-fences-adv-panel { width: 100%; margin-top: 10px; text-align: center; padding-top: 0px; padding-bottom: 8px; overflow-x: auto; }
#write .md-fences.mock-cm { white-space: pre-wrap; }
.md-fences.md-fences-with-lineno { padding-left: 0px; }
#write.fences-no-line-wrapping .md-fences.mock-cm { white-space: pre; overflow-x: auto; }
.md-fences.mock-cm.md-fences-with-lineno { padding-left: 8px; }
.CodeMirror-line, twitterwidget { break-inside: avoid; }
svg { break-inside: avoid; }
.footnotes { opacity: 0.8; font-size: 0.9rem; margin-top: 1em; margin-bottom: 1em; }
.footnotes + .footnotes { margin-top: 0px; }
.md-reset { margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: top; background: 0px 0px; text-decoration: none; text-shadow: none; float: none; position: static; width: auto; height: auto; white-space: nowrap; cursor: inherit; line-height: normal; font-weight: 400; text-align: left; box-sizing: content-box; direction: ltr; }
li div { padding-top: 0px; }
blockquote { margin: 1rem 0px; }
li .mathjax-block, li p { margin: 0.5rem 0px; }
li blockquote { margin: 1rem 0px; }
li { margin: 0px; position: relative; }
blockquote > :last-child { margin-bottom: 0px; }
blockquote > :first-child, li > :first-child { margin-top: 0px; }
.footnotes-area { color: rgb(136, 136, 136); margin-top: 0.714rem; padding-bottom: 0.143rem; white-space: normal; }
#write .footnote-line { white-space: pre-wrap; }
@media print {
  body, html { border: 1px solid transparent; height: 99%; break-after: avoid; break-before: avoid; font-variant-ligatures: no-common-ligatures; }
  #write { margin-top: 0px; border-color: transparent !important; padding-top: 0px !important; padding-bottom: 0px !important; }
  .typora-export * { print-color-adjust: exact; }
  .typora-export #write { break-after: avoid; }
  .typora-export #write::after { height: 0px; }
  .is-mac table { break-inside: avoid; }
  #write > p:nth-child(1) { margin-top: 0px; }
  .typora-export-show-outline .typora-export-sidebar { display: none; }
  figure { overflow-x: visible; }
}
.footnote-line { margin-top: 0.714em; font-size: 0.7em; }
a img, img a { cursor: pointer; }
pre.md-meta-block { font-size: 0.8rem; min-height: 0.8rem; white-space: pre-wrap; background: rgb(204, 204, 204); display: block; overflow-x: hidden; }
p > .md-image:only-child:not(.md-img-error) img, p > img:only-child { display: block; margin: auto; }
#write.first-line-indent p > .md-image:only-child:not(.md-img-error) img { left: -2em; position: relative; }
p > .md-image:only-child { display: inline-block; width: 100%; }
#write .MathJax_Display { margin: 0.8em 0px 0px; }
.md-math-block { width: 100%; }
.md-math-block:not(:empty)::after { display: none; }
.MathJax_ref { fill: currentcolor; }
[contenteditable="true"]:active, [contenteditable="true"]:focus, [contenteditable="false"]:active, [contenteditable="false"]:focus { outline: 0px; box-shadow: none; }
.md-task-list-item { position: relative; list-style-type: none; }
.task-list-item.md-task-list-item { padding-left: 0px; }
.md-task-list-item > input { position: absolute; top: 0px; left: 0px; margin-left: -1.2em; margin-top: calc(1em - 10px); border: medium; }
.math { font-size: 1rem; }
.md-toc { min-height: 3.58rem; position: relative; font-size: 0.9rem; border-radius: 10px; }
.md-toc-content { position: relative; margin-left: 0px; }
.md-toc-content::after, .md-toc::after { display: none; }
.md-toc-item { display: block; color: rgb(65, 131, 196); }
.md-toc-item a { text-decoration: none; }
.md-toc-inner:hover { text-decoration: underline; }
.md-toc-inner { display: inline-block; cursor: pointer; }
.md-toc-h1 .md-toc-inner { margin-left: 0px; font-weight: 700; }
.md-toc-h2 .md-toc-inner { margin-left: 2em; }
.md-toc-h3 .md-toc-inner { margin-left: 4em; }
.md-toc-h4 .md-toc-inner { margin-left: 6em; }
.md-toc-h5 .md-toc-inner { margin-left: 8em; }
.md-toc-h6 .md-toc-inner { margin-left: 10em; }
@media screen and (max-width: 48em) {
  .md-toc-h3 .md-toc-inner { margin-left: 3.5em; }
  .md-toc-h4 .md-toc-inner { margin-left: 5em; }
  .md-toc-h5 .md-toc-inner { margin-left: 6.5em; }
  .md-toc-h6 .md-toc-inner { margin-left: 8em; }
}
a.md-toc-inner { font-size: inherit; font-style: inherit; font-weight: inherit; line-height: inherit; }
.footnote-line a:not(.reversefootnote) { color: inherit; }
.reversefootnote { font-family: ui-monospace, sans-serif; }
.md-attr { display: none; }
.md-fn-count::after { content: "."; }
code, pre, samp, tt { font-family: var(--monospace); }
kbd { margin: 0px 0.1em; padding: 0.1em 0.6em; font-size: 0.8em; color: rgb(36, 39, 41); background: rgb(255, 255, 255); border: 1px solid rgb(173, 179, 185); border-radius: 3px; box-shadow: rgba(12, 13, 14, 0.2) 0px 1px 0px, rgb(255, 255, 255) 0px 0px 0px 2px inset; white-space: nowrap; vertical-align: middle; }
.md-comment { color: rgb(162, 127, 3); opacity: 0.6; font-family: var(--monospace); }
code { text-align: left; vertical-align: initial; }
a.md-print-anchor { white-space: pre !important; border-width: medium !important; border-style: none !important; border-color: currentcolor !important; display: inline-block !important; position: absolute !important; width: 1px !important; right: 0px !important; outline: 0px !important; background: 0px 0px !important; text-decoration: initial !important; text-shadow: initial !important; }
.os-windows.monocolor-emoji .md-emoji { font-family: "Segoe UI Symbol", sans-serif; }
.md-diagram-panel > svg { max-width: 100%; }
[lang="flow"] svg, [lang="mermaid"] svg { max-width: 100%; height: auto; }
[lang="mermaid"] .node text { font-size: 1rem; }
table tr th { border-bottom-width: 0px; border-bottom-style: none; border-bottom-color: currentcolor; }
video { max-width: 100%; display: block; margin: 0px auto; }
iframe { max-width: 100%; width: 100%; border: medium; }
.highlight td, .highlight tr { border: 0px; }
mark { background: rgb(255, 255, 0); color: rgb(0, 0, 0); }
.md-html-inline .md-plain, .md-html-inline strong, mark .md-inline-math, mark strong { color: inherit; }
.md-expand mark .md-meta { opacity: 0.3 !important; }
mark .md-meta { color: rgb(0, 0, 0); }
@media print {
  .typora-export h1, .typora-export h2, .typora-export h3, .typora-export h4, .typora-export h5, .typora-export h6 { break-inside: avoid; }
}
.md-diagram-panel .messageText { stroke: none !important; }
.md-diagram-panel .start-state { fill: var(--node-fill); }
.md-diagram-panel .edgeLabel rect { opacity: 1 !important; }
.md-fences.md-fences-math { font-size: 1em; }
.md-fences-advanced:not(.md-focus) { padding: 0px; white-space: nowrap; border: 0px; }
.md-fences-advanced:not(.md-focus) { background: inherit; }
.mermaid-svg { margin: auto; }
.typora-export-show-outline .typora-export-content { max-width: 1440px; margin: auto; display: flex; flex-direction: row; }
.typora-export-sidebar { width: 300px; font-size: 0.8rem; margin-top: 80px; margin-right: 18px; }
.typora-export-show-outline #write { --webkit-flex: 2; flex: 2 1 0%; }
.typora-export-sidebar .outline-content { position: fixed; top: 0px; max-height: 100%; overflow: hidden auto; padding-bottom: 30px; padding-top: 60px; width: 300px; }
@media screen and (max-width: 1024px) {
  .typora-export-sidebar, .typora-export-sidebar .outline-content { width: 240px; }
}
@media screen and (max-width: 800px) {
  .typora-export-sidebar { display: none; }
}
.outline-content li, .outline-content ul { margin-left: 0px; margin-right: 0px; padding-left: 0px; padding-right: 0px; list-style: none; overflow-wrap: anywhere; }
.outline-content ul { margin-top: 0px; margin-bottom: 0px; }
.outline-content strong { font-weight: 400; }
.outline-expander { width: 1rem; height: 1.428571rem; position: relative; display: table-cell; vertical-align: middle; cursor: pointer; padding-left: 4px; }
.outline-expander::before { content: ""; position: relative; font-family: Ionicons; display: inline-block; font-size: 8px; vertical-align: middle; }
.outline-item { padding-top: 3px; padding-bottom: 3px; cursor: pointer; }
.outline-expander:hover::before { content: ""; }
.outline-h1 > .outline-item { padding-left: 0px; }
.outline-h2 > .outline-item { padding-left: 1em; }
.outline-h3 > .outline-item { padding-left: 2em; }
.outline-h4 > .outline-item { padding-left: 3em; }
.outline-h5 > .outline-item { padding-left: 4em; }
.outline-h6 > .outline-item { padding-left: 5em; }
.outline-label { cursor: pointer; display: table-cell; vertical-align: middle; text-decoration: none; color: inherit; }
.outline-label:hover { text-decoration: underline; }
.outline-item:hover { border-color: rgb(245, 245, 245); background-color: var(--item-hover-bg-color); }
.outline-item:hover { margin-left: -28px; margin-right: -28px; border-left-width: 28px; border-left-style: solid; border-left-color: transparent; border-right-width: 28px; border-right-style: solid; border-right-color: transparent; }
.outline-item-single .outline-expander::before, .outline-item-single .outline-expander:hover::before { display: none; }
.outline-item-open > .outline-item > .outline-expander::before { content: ""; }
.outline-children { display: none; }
.info-panel-tab-wrapper { display: none; }
.outline-item-open > .outline-children { display: block; }
.typora-export .outline-item { padding-top: 1px; padding-bottom: 1px; }
.typora-export .outline-item:hover { margin-right: -8px; border-right-width: 8px; border-right-style: solid; border-right-color: transparent; }
.typora-export .outline-expander::before { content: "+"; font-family: inherit; top: -1px; }
.typora-export .outline-expander:hover::before, .typora-export .outline-item-open > .outline-item > .outline-expander::before { content: "−"; }
.typora-export-collapse-outline .outline-children { display: none; }
.typora-export-collapse-outline .outline-item-open > .outline-children, .typora-export-no-collapse-outline .outline-children { display: block; }
.typora-export-no-collapse-outline .outline-expander::before { content: "" !important; }
.typora-export-show-outline .outline-item-active > .outline-item .outline-label { font-weight: 700; }
.md-inline-math-container mjx-container { zoom: 0.95; }
mjx-container { break-inside: avoid; }
.md-alert.md-alert-note { border-left-color: rgb(9, 105, 218); }
.md-alert.md-alert-important { border-left-color: rgb(130, 80, 223); }
.md-alert.md-alert-warning { border-left-color: rgb(154, 103, 0); }
.md-alert.md-alert-tip { border-left-color: rgb(31, 136, 61); }
.md-alert.md-alert-caution { border-left-color: rgb(207, 34, 46); }
.md-alert { padding: 0px 1em; margin-bottom: 16px; color: inherit; border-left-width: 0.25em; border-left-style: solid; border-left-color: rgb(0, 0, 0); }
.md-alert-text-note { color: rgb(9, 105, 218); }
.md-alert-text-important { color: rgb(130, 80, 223); }
.md-alert-text-warning { color: rgb(154, 103, 0); }
.md-alert-text-tip { color: rgb(31, 136, 61); }
.md-alert-text-caution { color: rgb(207, 34, 46); }
.md-alert-text { font-size: 0.9rem; font-weight: 700; }
.md-alert-text svg { fill: currentcolor; position: relative; top: 0.125em; margin-right: 1ch; overflow: visible; }
.md-alert-text-container::after { content: attr(data-text); text-transform: capitalize; pointer-events: none; margin-right: 1ch; }


.CodeMirror { height: auto; }
.CodeMirror.cm-s-inner { background: inherit; }
.CodeMirror-scroll { overflow: auto hidden; z-index: 3; }
.CodeMirror-gutter-filler, .CodeMirror-scrollbar-filler { background-color: rgb(255, 255, 255); }
.CodeMirror-gutters { border-right-width: 1px; border-right-style: solid; border-right-color: rgb(221, 221, 221); background: inherit; white-space: nowrap; }
.CodeMirror-linenumber { padding: 0px 3px 0px 5px; text-align: right; color: rgb(153, 153, 153); }
.cm-s-inner .cm-keyword { color: rgb(119, 0, 136); }
.cm-s-inner .cm-atom, .cm-s-inner.cm-atom { color: rgb(34, 17, 153); }
.cm-s-inner .cm-number { color: rgb(17, 102, 68); }
.cm-s-inner .cm-def { color: rgb(0, 0, 255); }
.cm-s-inner .cm-variable { color: rgb(0, 0, 0); }
.cm-s-inner .cm-variable-2 { color: rgb(0, 85, 170); }
.cm-s-inner .cm-variable-3 { color: rgb(0, 136, 85); }
.cm-s-inner .cm-string { color: rgb(170, 17, 17); }
.cm-s-inner .cm-property { color: rgb(0, 0, 0); }
.cm-s-inner .cm-operator { color: rgb(152, 26, 26); }
.cm-s-inner .cm-comment, .cm-s-inner.cm-comment { color: rgb(170, 85, 0); }
.cm-s-inner .cm-string-2 { color: rgb(255, 85, 0); }
.cm-s-inner .cm-meta { color: rgb(85, 85, 85); }
.cm-s-inner .cm-qualifier { color: rgb(85, 85, 85); }
.cm-s-inner .cm-builtin { color: rgb(51, 0, 170); }
.cm-s-inner .cm-bracket { color: rgb(153, 153, 119); }
.cm-s-inner .cm-tag { color: rgb(17, 119, 0); }
.cm-s-inner .cm-attribute { color: rgb(0, 0, 204); }
.cm-s-inner .cm-header, .cm-s-inner.cm-header { color: rgb(0, 0, 255); }
.cm-s-inner .cm-quote, .cm-s-inner.cm-quote { color: rgb(0, 153, 0); }
.cm-s-inner .cm-hr, .cm-s-inner.cm-hr { color: rgb(153, 153, 153); }
.cm-s-inner .cm-link, .cm-s-inner.cm-link { color: rgb(0, 0, 204); }
.cm-negative { color: rgb(221, 68, 68); }
.cm-positive { color: rgb(34, 153, 34); }
.cm-header, .cm-strong { font-weight: 700; }
.cm-del { text-decoration: line-through; }
.cm-em { font-style: italic; }
.cm-link { text-decoration: underline; }
.cm-error { color: red; }
.cm-invalidchar { color: red; }
.cm-constant { color: rgb(38, 139, 210); }
.cm-defined { color: rgb(181, 137, 0); }
div.CodeMirror span.CodeMirror-matchingbracket { color: rgb(0, 255, 0); }
div.CodeMirror span.CodeMirror-nonmatchingbracket { color: rgb(255, 34, 34); }
.cm-s-inner .CodeMirror-activeline-background { background: inherit; }
.CodeMirror { position: relative; overflow: hidden; }
.CodeMirror-scroll { height: 100%; outline: 0px; position: relative; box-sizing: content-box; background: inherit; }
.CodeMirror-sizer { position: relative; }
.CodeMirror-gutter-filler, .CodeMirror-hscrollbar, .CodeMirror-scrollbar-filler, .CodeMirror-vscrollbar { position: absolute; z-index: 6; display: none; outline: 0px; }
.CodeMirror-vscrollbar { right: 0px; top: 0px; overflow: hidden; }
.CodeMirror-hscrollbar { bottom: 0px; left: 0px; overflow: auto hidden; }
.CodeMirror-scrollbar-filler { right: 0px; bottom: 0px; }
.CodeMirror-gutter-filler { left: 0px; bottom: 0px; }
.CodeMirror-gutters { position: absolute; left: 0px; top: 0px; padding-bottom: 10px; z-index: 3; overflow-y: hidden; }
.CodeMirror-gutter { white-space: normal; height: 100%; box-sizing: content-box; padding-bottom: 30px; margin-bottom: -32px; display: inline-block; }
.CodeMirror-gutter-wrapper { position: absolute; z-index: 4; background: 0px 0px !important; border: medium !important; }
.CodeMirror-gutter-background { position: absolute; top: 0px; bottom: 0px; z-index: 4; }
.CodeMirror-gutter-elt { position: absolute; cursor: default; z-index: 4; }
.CodeMirror-lines { cursor: text; }
.CodeMirror pre { border-radius: 0px; border-width: 0px; background: 0px 0px; font-family: inherit; font-size: inherit; margin: 0px; white-space: pre; overflow-wrap: normal; color: inherit; z-index: 2; position: relative; overflow: visible; }
.CodeMirror-wrap pre { overflow-wrap: break-word; white-space: pre-wrap; word-break: normal; }
.CodeMirror-code pre { border-right-width: 30px; border-right-style: solid; border-right-color: transparent; width: fit-content; }
.CodeMirror-wrap .CodeMirror-code pre { border-right-width: medium; border-right-style: none; border-right-color: currentcolor; width: auto; }
.CodeMirror-linebackground { position: absolute; inset: 0px; z-index: 0; }
.CodeMirror-linewidget { position: relative; z-index: 2; overflow: auto; }
.CodeMirror-wrap .CodeMirror-scroll { overflow-x: hidden; }
.CodeMirror-measure { position: absolute; width: 100%; height: 0px; overflow: hidden; visibility: hidden; }
.CodeMirror-measure pre { position: static; }
.CodeMirror div.CodeMirror-cursor { position: absolute; visibility: hidden; border-right-width: medium; border-right-style: none; border-right-color: currentcolor; width: 0px; }
.CodeMirror div.CodeMirror-cursor { visibility: hidden; }
.CodeMirror-focused div.CodeMirror-cursor { visibility: inherit; }
.cm-searching { background: rgba(255, 255, 0, 0.4); }
span.cm-underlined { text-decoration: underline; }
span.cm-strikethrough { text-decoration: line-through; }
.cm-tw-syntaxerror { color: rgb(255, 255, 255); background-color: rgb(153, 0, 0); }
.cm-tw-deleted { text-decoration: line-through; }
.cm-tw-header5 { font-weight: 700; }
.cm-tw-listitem:first-child { padding-left: 10px; }
.cm-tw-box { border-style: solid; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-color: inherit; border-top-width: 0px !important; }
.cm-tw-underline { text-decoration: underline; }
@media print {
  .CodeMirror div.CodeMirror-cursor { visibility: hidden; }
}


@include-when-export url(https://fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic&subset=latin-ext);
@include-when-export url(https://fonts.googleapis.com/css?family=Lato:900,300&subset=latin-ext);

:root {
	--control-text-color: #777;
}

/**
 * forked from pixyll.com
 * MIT license
 */

h1,
.h1,
.f1 {
	font-size: 2rem;
	line-height: 2.5rem;
}
h2,
.h2,
.f2 {
	font-size: 1.5rem;
	line-height: 2rem;
}
h3,
.h3,
.f3 {
	font-size: 1.25rem;
	line-height: 1.5rem;
}
p,
.p,
.f4,
h4,
h5,
h6,
dl,
ol,
ul,
pre[cid],
div[cid],
#typora-source {
	font-size: 1.125rem;
	line-height: 1.5rem;
}

h4 {
	font-size: 1.13rem;
}
/*
 Pixyll
 A simple, beautiful theme for Jekyll that emphasizes content rather than aesthetic fluff.
 Best served with BASSCSS (http://jxnblk.github.io/basscss)
 Crafted with <3 by John Otander (@4lpine) - ©2015 John Otander MIT License http://opensource.org/licenses/MIT

*/

body {
	font-family: "Merriweather", "PT Serif", Georgia, "Times New Roman", "STSong", 'Segoe UI Emoji', Serif;
	line-height: 1.5rem;
	font-weight: 400;
}

#write {
	max-width: 914px;
	color: #333;
}

@media only screen and (min-width: 1400px) {
	#write {
		max-width: 1100px;
	}
}

@media only screen and (min-width: 1700px) {
	#write {
		max-width: 1200px;
	}
}

img {
	width: auto;
	max-width: 100%;
}
body {
	font-size: 1.5rem;
	box-sizing: border-box;
	-moz-box-sizing: border-box;
	-webkit-box-sizing: border-box;
}

.ty-table-edit {
	background: #ededed;
}

table {
	width: 100%;
	font-size: 1.125rem;
}
table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td,
table > tfoot > tr > th,
table > tfoot > tr > td {
	padding: 12px;
	line-height: 1.2;
	vertical-align: top;
	border-top: 1px solid #333;
}
table > thead > tr > th {
	vertical-align: bottom;
	border-bottom: 2px solid #333;
}
table > caption + thead > tr:first-child > th,
table > caption + thead > tr:first-child > td,
table > colgroup + thead > tr:first-child > th,
table > colgroup + thead > tr:first-child > td,
table > thead:first-child > tr:first-child > th,
table > thead:first-child > tr:first-child > td {
	border-top: 0;
}
table > tbody + tbody {
	border-top: 2px solid #333;
}
p {
	font-weight: 300;
	line-height: 1.5;
}
abbr {
	border-bottom: 1px black dotted;
	cursor: help;
}
pre,
code {
	font-family: Menlo, Monaco, "Courier New", monospace;
}

code,
.md-fences  {
	color: #7a7a7a;
}

.md-fences {
	padding: 1.125em;
	margin-bottom: 0.88em;
	font-size: 1rem;
	border: 1px solid #7a7a7a;
	padding-bottom: 0.5rem;
	padding-top: 0.5rem;
}

blockquote {
	padding: 1.33em;
	font-style: italic;
	border-left: 5px solid #7a7a7a;
	color: #555;
}
blockquote em {
	color: #000;
}
blockquote footer {
	font-size: .85rem;
	font-style: normal;
	background-color: #fff;
	color: #7a7a7a;
	border-color: transparent;
}
h1,
.h1,
h2,
.h2,
h3,
.h3,
h4,
.h4,
h5,
.h5,
h6,
.h6 {
	font-family: "Lato", 'Helvetica Neue', Helvetica, sans-serif;
	font-weight: bold;
	line-height: 1.2;
	margin: 1em 0 0.5em;
}
@media screen and (min-width: 48em) {
	.h1,
	h1 {
		font-size: 3.250rem;
	}
	.h2,
	h2 {
		font-size: 2.298rem;
	}
	.h3,
	h3 {
		font-size: 1.625rem;
	}
	.h4,
	h4 {
		font-size: 1.3rem;
	}
	#write>h4.md-focus:before,
	#write>h5.md-focus:before,
	#write>h6.md-focus:before{
		top: 1px;
	}
	.p,
	p,
	li {
		font-size: 1.25rem;
		line-height: 1.8;
	}
	table {
		font-size: 1.25rem;
	}
}
@media (max-width: 48em) {
	blockquote {
		margin-left: 1rem;
		margin-right: 0;
		padding: 0.5em;
	}
	.h1,
	h1 {
		font-size: 2.827rem;
	}
	.h2,
	h2 {
		font-size: 1.999rem;
	}
	.h3,
	h3 {
		font-size: 1.413rem;
	}
	.h4,
	h4 {
		font-size: 1.3rem;
	}
}
@media screen and (min-width: 64em) {
	.h1,
	h1 {
		font-size: 4.498rem;
	}
	.h2,
	h2 {
		font-size: 2.29rem;
	}
	.h3,
	h3 {
		font-size: 1.9rem;
	}
	.h4,
	h4 {
		font-size: 1.591rem;
	}
	#write>h4.md-focus:before{
		top:4px;
	}
}
a {
	color: #463F5C;
	text-decoration: underline;
}

#write {
	padding-top: 2rem;
}

#write pre.md-meta-block {
	min-height: 35px;
	padding: 0.5em 1em;
	white-space: pre;
	border: 0px;

	border-left: 30px #f8f8f8 solid;
	border-right: 30px #f8f8f8 solid;
	width: 100vw;
	max-width: calc(100% + 60px);

	margin-left: -30px;
	margin-bottom: 2em;
	margin-top: -2010px;
	padding-top: 2000px;
	padding-bottom: 10px;
	line-height: 1.5em;
	color: #7a7a7a;
	background-color: #fafafa;
	font-family: 'Lato', 'Helvetica Neue', Helvetica, sans-serif;
	font-weight: 300;
	clear: both;
	padding-left: 0;
	font-size:1.125rem;
}
.md-image>.md-meta {
	color: #463F5C
}
.footnotes {
	font-size:1.1rem;
}
.md-tag {
	font-family: 'Lato', 'Helvetica Neue', Helvetica, sans-serif;
}
.code-tooltip {
	background: white;
}
.code-tooltip-content {
	font-size: 1.1rem;
}

.task-list{
	padding-left: 0;
}

.md-task-list-item {
	padding-left:34px;
}

.md-task-list-item > input{
	width: 1.25rem;
	height: 1.25rem;
	display: block;
	-webkit-appearance: initial;
	top: -0.2rem;
	margin-left: -1.6em;
	margin-top: calc(1rem - 7px);
	border: none;
}

.md-task-list-item > input:focus{
	outline: none;
	box-shadow: none;
}

.md-task-list-item > input:before{
	border: 1px solid #555;
	border-radius: 1.5rem;
	width: 1.5rem;
	height: 1.5rem;
	background: #fff;
	content: ' ';
	transition: background-color 200ms ease-in-out;
	display: block;
}

.md-task-list-item > input:checked:before,
.md-task-list-item > input[checked]:before{
	background: #333;
	border-width: 2px;
	display:inline-block;
	transition: background-color 200ms ease-in-out;
}

.md-task-list-item > input:checked:after,
.md-task-list-item > input[checked]:after {
	opacity: 1;
}

.md-task-list-item > input:after {
	opacity: 1;
	-webkit-transition: opacity 0.05s ease-in-out;
	-moz-transition: opacity 0.05s ease-in-out;
	transition: opacity 0.05s ease-in-out;
	-webkit-transform: rotate(-45deg);
	-moz-transform: rotate(-45deg);
	transform: rotate(-45deg);
	position: absolute;
	top: 0.4375rem;
	left: 0.28125rem;
	width: 0.9375rem;
	height: 0.5rem;
	border: 3px solid #fff;
	border-top: 0;
	border-right: 0;
	content: ' ';
	opacity: 0;
}

.md-tag {
	color:inherit;
}

.md-toc:focus .md-toc-content{
	margin-top: 19px;
}

#typora-sidebar {
	font-size:1rem !important;
}

.html-for-mac #typora-sidebar {
	background-color:white;
}

.outline-content li, .outline-content ul {
	font-size:1rem !important;
}

.outline-title {
	line-height: inherit;
	margin-top: 10px;
}

.outline-expander {
	width: 18px;
}

.outline-expander:before {
 	content: "+";
	font-family: inherit;
	color: rgb(108, 108, 108); 
  font-size: 1.5rem;
 	top: -0.1rem;
}

.outline-expander:hover:before {
	content: "+";
}

.outline-item-open>.outline-item>.outline-expander:before{
	content: "-";
}

/** source code mode */
#typora-source {
	font-family: Courier, monospace;
    color: #6A6A6A;
}

.os-windows #typora-source {
	font-family: inherit;
}

.cm-s-typora-default .cm-header, 
.cm-s-typora-default .cm-property,
.CodeMirror.cm-s-typora-default div.CodeMirror-cursor {
	color: #428bca;
}

.cm-s-typora-default .cm-atom, .cm-s-typora-default .cm-number {
	color: #777777;
}

.md-diagram-panel {
	margin-top: 24px;
	margin-left: -1.2em;
}

.md-mathjax-midline {
	background: #fafafa;
}

.enable-diagrams pre.md-fences[lang="sequence"] .code-tooltip,
.enable-diagrams pre.md-fences[lang="flow"] .code-tooltip,
.enable-diagrams pre.md-fences[lang="mermaid"] .code-tooltip {
    bottom: -3.4em;
}

.dropdown-menu .divider {
	border-color: #e5e5e5;
}

li {
	margin: 0.5rem 0;
}

li > *:last-child {
	margin-bottom: 0;
}

p img + em {
  display: block;
  text-align: center;
  font-size: 0.85em;
  color: gray;
  margin-top: 4px;
}


 @media print { @page {margin: 0 0 0 0;} body.typora-export {padding-left: 0; padding-right: 0;} #write {padding:0;}}
</style><title>Chapter6</title>
</head>
<body class='typora-export'><div class='typora-export-content'>
<div id='write'  class=''><h1 id='chapter-6'><span>Chapter 6</span></h1><h2 id='integrating-aws-and-deploying-with-cicd'><span>Integrating AWS and Deploying with CI/CD</span></h2><p><em><span>Ethan watched the pipeline status turn green in GitLab. The </span><code>prepare</code><span> stage installed dependencies and cached them, and the </span><code>validate</code><span> stage successfully ran both the linter and the unit tests using the cache. It was satisfying to see the automation working reliably after every push.</span></em></p><p><em><span>&quot;Alright, Maya,&quot; Ethan said, &quot;this is really cool! The pipeline automatically checks my code quality and runs the basic Jest test every time I push. It feels much safer already. But,&quot; he added, looking at the </span><code>.gitlab-ci.yml</code><span> file, &quot;we&#39;re still missing the actual CDK parts, like </span><code>synth</code><span> and eventually </span><code>deploy</code><span> for the S3 bucket stack we built in Book 1.&quot;</span></em></p><p><em><span>Maya nodded. &quot;Exactly. Our current pipeline validates the code itself, but it doesn&#39;t interact with AWS or check the infrastructure definitions in detail. To run commands like </span><code>cdk synth</code><span> (which might perform context lookups requiring AWS API calls) or </span><code>cdk deploy</code><span> (which definitely needs to interact with AWS), our pipeline needs two things: the necessary AWS credentials and the permissions associated with those credentials.&quot;</span></em></p><p><em><span>&quot;Ah, right,&quot; Ethan recalled. &quot;Like how my local terminal needs my </span><code>magicmail-dev</code><span> profile configured to deploy?&quot;</span></em></p><p><em><span>&quot;Precisely,&quot; Maya confirmed. &quot;But we can&#39;t just hardcode our secret access keys directly into the </span><code>.gitlab-ci.yml</code><span> file – that would be a major security risk! Anyone who could see the code could steal our credentials. We need a secure way to provide these credentials to the GitLab Runner only when it needs them to run specific jobs that interact with AWS.&quot;</span></em></p><p><em><span>&quot;So, this chapter is about connecting the pipeline securely to AWS and adding the actual CDK commands to manage our existing </span><code>MagicmailInfraStack</code><span>?&quot;</span></em><span> Ethan asked.</span></p><p><em><span>&quot;You got it,&quot; Maya replied. &quot;We&#39;ll explore secure methods for handling AWS credentials in GitLab CI/CD, add jobs to synthesize our stacks, preview changes with </span><code>cdk diff</code><span>, and finally, add a deployment job with a manual approval step, bringing us closer to fully automated infrastructure management.&quot;</span></em></p><hr /><p><span>&quot;Running </span><code>cdk synth</code><span> and </span><code>cdk deploy</code><span> from our CI/CD pipeline unlocks the true power of automating infrastructure management,&quot; Maya began. &quot;But it requires careful handling of AWS credentials.&quot;</span></p><h2 id='securely-handling-aws-credentials-in-gitlab-cicd'><span>Securely Handling AWS Credentials in GitLab CI/CD</span></h2><p><span>&quot;Hardcoding credentials in </span><code>.gitlab-ci.yml</code><span> is never acceptable,&quot; Maya stated firmly. &quot;GitLab provides a secure mechanism for this: </span><strong><span>CI/CD Variables</span></strong><span>.&quot;</span></p><ul><li><p><strong><span>What are CI/CD Variables?</span></strong><span> These are key-value pairs that you can define within GitLab&#39;s settings (at the project, group, or instance level). GitLab makes these variables available as environment variables to the runner during job execution.</span></p></li><li><p><strong><span>Security Features:</span></strong></p><ul><li><p><strong><span>Protected:</span></strong><span> Variables marked as &#39;Protected&#39; are only passed to jobs running on protected branches (like </span><code>main</code><span> by default) or protected tags. This prevents them from being exposed in pipelines running on feature branches.</span></p></li><li><p><strong><span>Masked:</span></strong><span> Variables marked as &#39;Masked&#39; will have their values replaced with </span><code>[MASKED]</code><span> in job logs, preventing accidental exposure. </span><em><span>Note: Masking has limitations and might not work perfectly for complex, multi-line secrets.</span></em></p></li></ul></li><li><p><strong><span>Scope:</span></strong><span> Variables can be scoped to specific environments (like </span><code>production</code><span>, </span><code>staging</code><span>), which is useful for managing different credentials for different deployment targets.</span></p></li></ul><h3 id='strategy-using-iam-user-credentials-via-variables'><span>Strategy: Using IAM User Credentials via Variables</span></h3><p><span>&quot;For our setup, the most straightforward approach is to create a dedicated IAM user for our CI/CD pipeline, grant it the necessary permissions to deploy our CDK stacks, and then store its AWS Access Key ID and Secret Access Key as protected, masked CI/CD variables in GitLab.&quot;</span></p><ol start='' ><li><p><strong><span>Create CI/CD IAM User (Manual Step):</span></strong></p><ul><li><p><span>&quot;First, we need an IAM user in our AWS account specifically for GitLab CI/CD,&quot; Maya instructed. &quot;Go to the AWS IAM console.&quot;</span></p></li><li><p><span>Create a new user (e.g., </span><code>gitlab-cicd-user</code><span>).</span></p></li><li><p><span>Select &quot;Provide user access to the AWS console - optional&quot; </span></p></li><li><p><span>Attach policies directly: Search for and attach the </span><code>AdministratorAccess</code><span> policy. </span><strong><span>WARNING:</span></strong><span> Granting AdministratorAccess is </span><strong><span>highly discouraged</span></strong><span> for production pipelines due to security risks. For this learning exercise, it simplifies permission management, but in a real-world scenario, you would create a custom policy granting only the </span><em><span>minimum necessary permissions</span></em><span> required for CDK deployment (e.g., CloudFormation access, permissions for specific services being created like S3, DynamoDB, IAM roles, etc.). We will refine permissions later.</span></p></li><li><p><span>Complete user creation.</span></p></li><li><p><strong><span>Crucially:</span></strong><span> On the final screen, copy the </span><strong><span>Access key ID</span></strong><span> and the </span><strong><span>Secret access key</span></strong><span>. Store these securely </span><em><span>temporarily</span></em><span> – you&#39;ll need them in the next step, and the secret key won&#39;t be shown again.</span></p><p><img src="images/book2-chap6-create-runner-iam-user.png" referrerpolicy="no-referrer" alt="book2-chap6-create-runner-iam-user">
<em><span>Caption: Creating a dedicated IAM user and copying its credentials.</span></em></p><p>&nbsp;</p></li></ul></li><li><p><strong><span>Add Credentials as GitLab CI/CD Variables:</span></strong></p><ul><li><p><span>&quot;Now, go back to your </span><code>magicmail-infra</code><span> project in GitLab.&quot;</span></p></li><li><p><span>Navigate to </span><strong><span>Settings -&gt; CI/CD</span></strong><span>.</span></p></li><li><p><span>Expand the </span><strong><span>Variables</span></strong><span> section.</span></p></li><li><p><span>Click </span><strong><span>Add variable</span></strong><span>.</span></p></li><li><p><span>Create three variables:</span></p><ul><li><p><strong><span>Key:</span></strong><span> </span><code>AWS_ACCESS_KEY_ID</code></p><ul><li><p><strong><span>Value:</span></strong><span> Paste the Access Key ID you just copied from AWS.</span></p></li><li><p><strong><span>Flags:</span></strong><span> Check </span><strong><span>Protect variable</span></strong><span> and </span><strong><span>Mask variable</span></strong><span>.</span></p></li><li><p><span>Click </span><strong><span>Add variable</span></strong><span>.</span></p></li></ul></li><li><p><strong><span>Key:</span></strong><span> </span><code>AWS_SECRET_ACCESS_KEY</code></p><ul><li><p><strong><span>Value:</span></strong><span> Paste the Secret Access Key you copied from AWS.</span></p></li><li><p><strong><span>Flags:</span></strong><span> Check </span><strong><span>Protect variable</span></strong><span> and </span><strong><span>Mask variable</span></strong><span>.</span></p></li><li><p><span>Click </span><strong><span>Add variable</span></strong><span>.</span></p></li></ul></li><li><p><strong><span>Key:</span></strong><span> </span><code>AWS_DEFAULT_REGION</code></p><ul><li><p><strong><span>Value:</span></strong><span> Enter your target AWS region (e.g., </span><code>us-east-1</code><span>).</span></p></li><li><p><strong><span>Flags:</span></strong><span> Leave Protect/Mask unchecked (region is not sensitive).</span></p></li><li><p><span>Click </span><strong><span>Add variable</span></strong><span>.</span></p></li></ul><p><img src="images/book2-chap6-cicd-variables.png" referrerpolicy="no-referrer" alt="book2-chap6-cicd-variables">
<em><span>Caption: Adding AWS credentials as protected and masked CI/CD variables in GitLab.</span></em></p></li></ul></li></ul></li></ol><p><span>&quot;Now, GitLab will securely inject these three variables as environment variables into the runner&#39;s environment for jobs running on protected branches/tags.&quot;</span></p><h3 id='configuring-aws-credentials-in-the-job'><span>Configuring AWS Credentials in the Job</span></h3><p><span>&quot;Next, we need to tell the tools running inside the Docker container (specifically, the AWS CLI and CDK) to use these credentials. We do this using a </span><code>before_script</code><span> section in the jobs that need AWS access.&quot;</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="yaml" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="yaml"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.5px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Example job needing AWS credentials</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">synth_job</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  stage</span><span class="cm-meta">: </span>synth <span class="cm-comment"># Example stage</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  before_script</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>echo <span class="cm-string">"Configuring AWS credentials..."</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># Install AWS CLI if not present in the base image</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>apt-get update -y &amp;&amp; apt-get install -y awscli</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># Configure AWS CLI using the variables provided by GitLab</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>aws configure set region $AWS_DEFAULT_REGION</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>echo <span class="cm-string">"AWS configuration complete."</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  script</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>echo <span class="cm-string">"Running AWS/CDK command..."</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>npx cdk synth <span class="cm-comment"># CDK will automatically use the configured credentials</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 336px;"></div><div class="CodeMirror-gutters" style="display: none; height: 336px;"></div></div></div></pre><ul><li><p><code>before_script:</code><span>: Runs before the main script: section.</span></p></li><li><p><code>apt-get install -y awscli</code><span>: Installs the AWS CLI inside the container (necessary as the base </span><code>node:18</code><span> image doesn&#39;t include it). (Note: For future projects, especially those not primarily Node.js based, using a pre-built Docker image from sources like AWS ECR Public Gallery that already includes the AWS CLI can be more efficient than installing it in every job run).</span></p></li><li><p><code>aws configure set ...</code><span>: Uses the environment variables (</span><code>$AWS_ACCESS_KEY_ID</code><span>, etc.) injected by GitLab to configure the default AWS CLI profile within the container.</span></p></li><li><p><span>CDK Usage: The AWS CDK Toolkit automatically detects and uses credentials configured for the default AWS CLI profile.</span></p></li></ul><p><span>&quot;With this setup, our pipeline jobs can securely interact with AWS.&quot;</span></p><h2 id='adding-the-synth-stage'><span>Adding the </span><code>synth</code><span>Stage</span></h2><p><span>&quot;Let&#39;s integrate the cdk </span><code>synth</code><span> command into our pipeline,&quot; Maya suggested. &quot;This command synthesizes our CDK code into a CloudFormation template. Running it in CI ensures that our code is valid and can be translated into a deployable format. It also performs context lookups (like finding the </span><code>default VPC</code><span> or </span><code>AMI ID</code><span>s), which requires the AWS credentials we just configured.&quot;</span></p><p><span>&quot;We&#39;ll add a new </span><code>synth</code><span> stage to our </span><code>.gitlab-ci.yml</code><span> file, running after the </span><code>validate</code><span> stage.&quot;</span></p><h3 id='updating-gitlab-ciyml'><span>Updating </span><code>.gitlab-ci.yml</code></h3><p><span>&quot;Modify your local </span><code>.gitlab-ci.yml</code><span> file:&quot;</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="yaml" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="yaml"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.5px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># .gitlab-ci.yml - Version 4 (Adding Synth Stage)</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Define the stages</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">stages</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">  - </span>prepare</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">  - </span>validate</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">  - </span>synth &nbsp; &nbsp;<span class="cm-comment"># &lt;-- Add synth stage</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">default</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  image</span><span class="cm-meta">: </span>node<span class="cm-meta">:</span><span class="cm-number">18</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  tags</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>docker</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># --- (prepare, validate jobs stay the same) ---</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># --- Synth Stage --- &lt;-- NEW STAGE &amp; JOB</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">synthesize_template</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  stage</span><span class="cm-meta">: </span>synth</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  before_script</span><span class="cm-meta">: </span><span class="cm-comment"># Configure AWS credentials for this job</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>echo <span class="cm-string">"Configuring AWS credentials for synth..."</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>apt-get update -y &amp;&amp; apt-get install -y awscli</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>aws configure set region $AWS_DEFAULT_REGION</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>echo <span class="cm-string">"AWS configuration complete."</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  script</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>echo <span class="cm-string">"Compiling TypeScript (needed for synth)..."</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>npm run build <span class="cm-comment"># Synth requires compiled JS code</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>echo <span class="cm-string">"Synthesizing CloudFormation templates..."</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># Synthesize the main stack (adjust if you have multiple)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>npx cdk synth MagicmailInfraStack</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># Optional: Synthesize other stacks if needed, like the GitLab server stack</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># - npx cdk synth GitLabServerStack</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  needs</span><span class="cm-meta">: [</span>install_deps<span class="cm-meta">]</span> <span class="cm-comment"># Needs dependencies installed</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  cache</span><span class="cm-meta">: </span><span class="cm-comment"># Reuse the cache</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  key</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp; &nbsp;  files</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp; &nbsp; &nbsp;  - </span>package-lock.json</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  paths</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp; &nbsp;  - </span>node_modules/</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  policy</span><span class="cm-meta">: </span>pull</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  artifacts</span><span class="cm-meta">: </span><span class="cm-comment"># Save the synth output</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  paths</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp; &nbsp;  - </span>cdk.out/</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  expire_in</span><span class="cm-meta">: </span>1 day</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 1029px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1029px;"></div></div></div></pre><p><span>&quot;Here&#39;s what we did:&quot;</span></p><ul><li><p><strong><span>Added </span><code>synth</code><span> to </span><code>stages</code><span>:</span></strong><span> Defined the new stage, ensuring it runs after validate.</span></p></li><li><p><strong><span>Created </span><code>synthesize_template</code><span> Job:</span></strong></p><ul><li><p><span>Assigned it to the </span><code>synth</code><span> stage.</span></p></li><li><p><span>Added the </span><code>before_script</code><span> section to install the AWS CLI and configure credentials using the GitLab CI/CD variables (</span><code>$AWS_ACCESS_KEY_ID</code><span>, etc.).</span></p></li><li><p><span>The main </span><code>script</code><span> first runs </span><code>npm run build</code><span> (since </span><code>cdk synth</code><span> needs the compiled JavaScript) and then runs </span><code>npx cdk synth MagicmailInfraStack</code><span>. We are focusing on the main application stack from Book 1.</span></p></li><li><p><span>Included </span><code>needs: [install_deps]</code><span> and </span><code>cache</code><span>: to reuse the </span><code>node_modules</code><span> cache.</span></p></li><li><p><span>Added the </span><code>artifacts:</code><span> section to save the </span><code>cdk.out</code><span> directory, which now contains the synthesized CloudFormation template.</span></p></li></ul></li></ul><p><strong><span>Committing and Running the Updated Pipeline</span></strong>
<span>&quot;Save the changes to </span><code>.gitlab-ci.yml</code><span>.&quot;</span></p><p><span>&quot;Commit and push</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.5px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Stage the changes</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> add .gitlab-ci.yml</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Commit the changes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> commit <span class="cm-attribute">-m</span> <span class="cm-string">"ci: Add synth stage and configure AWS credentials"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Push the changes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> push origin main</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 168px;"></div><div class="CodeMirror-gutters" style="display: none; height: 168px;"></div></div></div></pre><p><span>&quot;Now, check the pipeline in GitLab (</span><strong><span>CI/CD -&gt; Pipelines</span></strong><span>). You should see the new </span><code>synth</code><span> stage appear after </span><code>validate</code><span>. The </span><code>synthesize_template</code><span> job will run, install the AWS CLI, configure credentials, compile the code, and finally execute </span><code>cdk synth</code><span>. If it succeeds, it means our pipeline can now securely authenticate to AWS and synthesize our CDK application!&quot;</span></p><p><img src="images/book2-chap6-cicd-synth.png" referrerpolicy="no-referrer" alt="book2-chap6-cicd-synth">
<em><span>Caption: Pipeline view showing the added synth stage.</span></em></p><p><img src="images/book2-chap6-cicd-log-synth.png" referrerpolicy="no-referrer" alt="book2-chap6-cicd-log-synth">
<em><span>Caption: Job log showing successful AWS configuration and CDK synthesis.</span></em></p><h2 id='adding-the-diff-stage'><span>Adding the </span><code>diff</code><span> Stage</span></h2><p><span>&quot;Synthesizing is good, but before deploying infrastructure changes, it&#39;s crucial to understand exactly what those changes are,&quot; Maya stressed. &quot;The </span><code>cdk diff</code><span> command compares the template generated by your current code (the one synthesized in the previous stage) against the currently deployed CloudFormation stack in AWS. It shows you a summary of additions, modifications, and deletions.&quot;</span></p><p><span>&quot;Running </span><code>cdk diff</code><span> in the pipeline provides a vital safety check and review point.&quot;</span></p><p><span>&quot;Let&#39;s add a </span><code>diff</code><span> stage after </span><code>synth</code><span>.&quot;</span></p><h3 id='updating-gitlab-ciyml-diff'><span>Updating </span><code>.gitlab-ci.yml</code><span> (Diff)</span></h3><p><span>&quot;Modify your local </span><code>.gitlab-ci.yml</code><span> file again:&quot;</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="yaml" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="yaml"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.5px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># .gitlab-ci.yml - Version 5 (Adding Diff Stage)</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Define the stages</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">stages</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">  - </span>prepare</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">  - </span>validate</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">  - </span>synth</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">  - </span>diff &nbsp; &nbsp; <span class="cm-comment"># &lt;-- Add diff stage</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">default</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  image</span><span class="cm-meta">: </span>node<span class="cm-meta">:</span><span class="cm-number">18</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  tags</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>docker</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># --- (prepare, validate, synth jobs stay the same) ---</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># --- Diff Stage --- &lt;-- NEW STAGE &amp; JOB</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">preview_changes</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  stage</span><span class="cm-meta">: </span>diff</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  before_script</span><span class="cm-meta">: </span><span class="cm-comment"># Also needs AWS credentials</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>echo <span class="cm-string">"Configuring AWS credentials for diff..."</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>apt-get update -y &amp;&amp; apt-get install -y awscli</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>aws configure set region $AWS_DEFAULT_REGION</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>echo <span class="cm-string">"AWS configuration complete."</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  script</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>echo <span class="cm-string">"Compiling TypeScript (needed for diff)..."</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>npm run build <span class="cm-comment"># Diff also needs compiled code</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>echo <span class="cm-string">"Checking for infrastructure changes..."</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># Run cdk diff for the main stack</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>npx cdk diff MagicmailInfraStack</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  needs</span><span class="cm-meta">: [</span>install_deps<span class="cm-meta">]</span> <span class="cm-comment"># Needs dependencies installed</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># Could also depend on 'synthesize_template' if we used its artifacts</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  cache</span><span class="cm-meta">: </span><span class="cm-comment"># Reuse the cache</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  key</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp; &nbsp;  files</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp; &nbsp; &nbsp;  - </span>package-lock.json</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  paths</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp; &nbsp;  - </span>node_modules/</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  policy</span><span class="cm-meta">: </span>pull</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment"># This job typically runs on all branches (including merge requests)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment"># to allow reviewing changes before merge/deploy.</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-comment"># We'll refine rules later.</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 987px;"></div><div class="CodeMirror-gutters" style="display: none; height: 987px;"></div></div></div></pre><p><span>&quot;Key changes:&quot;</span></p><ul><li><p><strong><span>Added </span><code>diff</code><span> to </span><code>stages</code><span>:</span></strong><span> Runs after </span><code>synth</code><span>.</span></p></li><li><p><strong><span>Created </span><code>preview_changes</code><span> Job:</span></strong></p><ul><li><p><span>Assigned to the </span><code>diff</code><span> stage.</span></p></li><li><p><span>Includes the </span><code>before_script</code><span> to configure AWS credentials.</span></p></li><li><p><span>Runs </span><code>npm run build</code><span> (as </span><code>cdk diff</code><span> also needs the compiled code to compare against the deployed state).</span></p></li><li><p><span>Runs </span><code>npx cdk diff MagicmailInfraStack</code><span> to compare the synthesized template with the deployed stack.</span></p></li><li><p><span>Includes </span><code>needs: [install_deps]</code><span> and </span><code>cache:</code><span>. (Note: We could make it </span><code>needs: [synthesize_template]</code><span> and potentially use the artifacts from </span><code>synth</code><span> instead of rebuilding, but for simplicity now, we rebuild).</span></p></li></ul></li></ul><p><strong><span>Committing and Running the Updated Pipeline (Diff)</span></strong>
<span>&quot;Save the changes to </span><code>.gitlab-ci.yml.</code><span>&quot;</span>
<span>&quot;Commit and push:&quot;</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.5px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Stage the changes</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> add .gitlab-ci.yml</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Commit the changes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> commit <span class="cm-attribute">-m</span> <span class="cm-string">"ci: Add diff stage to preview changes"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Push the changes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> push origin main</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 168px;"></div><div class="CodeMirror-gutters" style="display: none; height: 168px;"></div></div></div></pre><p><span>&quot;Check the pipeline again. The new </span><code>diff</code><span> stage with the </span><code>preview_changes</code><span> job will run after </span><code>synth</code><span>. Click into the job log – you should see the output of </span><code>cdk diff</code><span>. If there are no changes between your code and the deployed stack, it will likely just print the stack ARN. If there are differences (e.g., if you modified the S3 bucket properties locally but hadn&#39;t deployed yet), it would show a summary of those changes.&quot;</span></p><p><img src="images/book2-chap6-cicd-diff.png" referrerpolicy="no-referrer" alt="book2-chap6-cicd-diff">
<em><span>Caption: Pipeline view showing the added diff stage.</span></em></p><p><img src="images/book2-chap6-cicd-log-diff.png" referrerpolicy="no-referrer" alt="book2-chap6-cicd-log-diff">
<em><span>Caption: Job log showing the output of </span><code>cdk diff</code><span>.</span></em></p><p><span>&quot;This </span><code>diff</code><span> step is invaluable. In a team workflow, you&#39;d typically run this pipeline on Merge Requests, allowing reviewers to see the exact infrastructure impact before approving the merge.&quot;</span></p><p>&nbsp;</p><h2 id='adding-the-deploy-stage-with-manual-approval'><span>Adding the </span><code>deploy</code><span> Stage (with Manual Approval)</span></h2><p><span>&quot;Alright, Ethan,&quot; Maya said, &quot;our pipeline can now validate, synthesize, and preview changes. The final step is to automate the deployment itself — using </span><code>cdk deploy</code><span>.&quot;</span></p><p><span>&quot;We&#39;ll add a new </span><code>deploy</code><span> stage and create a </span><code>deploy_app</code><span> job that handles deploying the </span><code>MagicmailInfraStack</code><span> to AWS.&quot;</span></p><p><span>Maya paused for emphasis. &quot;Now, technically, we could configure it so that every time you push to </span><code>main</code><span>, the deployment happens automatically. But that can be </span><strong><span>dangerous</span></strong><span>.&quot;</span></p><p><span>&quot;Imagine a small typo in your CDK code accidentally deletes a resource — and the pipeline immediately deploys it to production without anyone reviewing the change. Full automation sounds cool, but when it comes to infrastructure, </span><strong><span>moving too fast without checks can cause real damage.</span></strong><span>&quot;</span></p><p><span>&quot;That&#39;s why we&#39;ll configure the deployment job with a </span><strong><span>manual approval gate</span></strong><span>. After the pipeline runs </span><code>cdk diff</code><span> and shows what would change, the deploy job will </span><strong><span>pause</span></strong><span>. You&#39;ll be able to review the diff carefully, and only when you&#39;re confident, manually trigger the deployment by clicking a button in GitLab.&quot;</span></p><p><span>Ethan nodded. &quot;Makes sense — safety first.&quot;</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="yaml" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="yaml"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.5px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># .gitlab-ci.yml - Version 7 (Adding Deploy Stage with Manual Approval Gate)</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Define the stages</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">stages</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">  - </span>prepare</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">  - </span>validate</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">  - </span>synth</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">  - </span>diff</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">  - </span>deploy</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">default</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  image</span><span class="cm-meta">: </span>node<span class="cm-meta">:</span><span class="cm-number">18</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  tags</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>docker</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># --- (prepare, validate, synth, diff jobs stay the same) ---</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># --- Deploy Stage --- &lt;-- NEW STAGE &amp; JOB</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">deploy_app</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  stage</span><span class="cm-meta">: </span>deploy</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  before_script</span><span class="cm-meta">: </span><span class="cm-comment"># Also needs AWS credentials</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>echo <span class="cm-string">"Configuring AWS credentials for deploy..."</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>apt-get update -y &amp;&amp; apt-get install -y awscli</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>aws configure set region $AWS_DEFAULT_REGION</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>echo <span class="cm-string">"AWS configuration complete."</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  script</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>echo <span class="cm-string">"Compiling TypeScript (needed for deploy)..."</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>npm run build <span class="cm-comment"># Deploy also needs compiled code</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>echo <span class="cm-string">"Deploying CDK stack..."</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># Deploy the main stack; --require-approval never avoids interactive prompts in CI</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>npx cdk deploy MagicmailInfraStack --require-approval never</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  needs</span><span class="cm-meta">: [</span>preview_changes<span class="cm-meta">]</span> <span class="cm-comment"># Run only after diff job succeeds</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  cache</span><span class="cm-meta">: </span><span class="cm-comment"># Reuse the cache</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  key</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp; &nbsp;  files</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp; &nbsp; &nbsp;  - </span>package-lock.json</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  paths</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp; &nbsp;  - </span>node_modules/</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  policy</span><span class="cm-meta">: </span>pull</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  rules</span><span class="cm-meta">: </span><span class="cm-comment"># Control when this job runs</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span><span class="cm-atom">if</span><span class="cm-meta">: </span><span class="cm-string">'$CI_COMMIT_BRANCH == "main"'</span> <span class="cm-comment"># Only run on pushes/merges to the main branch</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp; &nbsp;  when</span><span class="cm-meta">: </span>manual <span class="cm-comment"># Run only if manually triggered</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp; &nbsp;  allow_failure</span><span class="cm-meta">: </span>false <span class="cm-comment"># Optional: Fail pipeline if manual job isn't run/fails</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 1050px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1050px;"></div></div></div></pre><p><strong><span>Key changes:</span></strong></p><ul><li><p><strong><span>Added </span><code>deploy</code><span> to </span><code>stages</code><span>:</span></strong><span> Defines </span><code>deploy</code><span> as the final stage.</span></p></li><li><p><strong><span>Created </span><code>deploy_app</code><span> job:</span></strong></p><ul><li><p><span>Assigned it to the </span><code>deploy</code><span> stage.</span></p></li><li><p><span>Configures AWS credentials using </span><code>before_script</code><span>.</span></p></li><li><p><span>Runs </span><code>npm run build</code><span> and </span><code>npx cdk deploy MagicmailInfraStack --require-approval never</code><span>.</span></p></li><li><p><strong><span>Depends on </span><code>preview_changes</code><span>:</span></strong><span> Ensures deployment only happens if the diff succeeds.</span></p></li><li><p><strong><span>Added </span><code>rules:</code><span> section:</span></strong></p></li><li><p><span>if: </span><code>&#39;$CI_COMMIT_BRANCH == &quot;main&quot;&#39;</code><span>: Only deploy when changes are merged into </span><code>main</code><span>.</span></p></li><li><p><code>when: manual</code><span>: Pauses the pipeline after the diff; requires a manual trigger to deploy.</span></p></li><li><p><code>allow_failure: false</code><span>: (Optional) Fails the pipeline if the deploy is skipped or fails.</span></p></li></ul></li></ul><h3 id='optimizing-with-yaml-anchors'><span>Optimizing with YAML Anchors</span></h3><p><span>&quot;One more thing before we commit this... let&#39;s optimize it!&quot; Maya suggested. &quot;Notice the </span><code>before_script</code><span> for AWS configuration is repeated in </span><code>synthesize_template</code><span>, </span><code>preview_change</code><span>s, and </span><code>deploy_app</code><span>. We can define it once using an anchor.&quot;</span></p><p><span>&quot;</span><em><span>Oh yeah, that does look repetitive,</span></em><span>&quot; Ethan observed. &quot;</span><em><span>Is there a way to avoid copying and pasting that setup?</span></em><span>&quot;</span></p><p><span>&quot;Exactly!&quot; Maya confirmed. &quot;We use a YAML feature called </span><strong><span>Anchors</span></strong><span> and </span><strong><span>Aliases</span></strong><span>. We define a reusable block in a hidden job (name starts with </span><code>.</code><span>) and give it an anchor (</span><code>&amp;</code><span>). Then, other jobs use an alias (</span><code>*</code><span>) to include that block.&quot;</span></p><p><span>&quot;Add the </span><code>.aws_configure_template</code><span> hidden job at the top and replace the </span><code>before_script</code><span> sections in the other jobs with </span><code>&lt;&lt;: *aws_configure</code><span>.&quot;</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="yaml" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="yaml"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.5px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># .gitlab-ci.yml - Version 8 (Optimized)</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Define a hidden job template for AWS configuration</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">.aws_configure_template</span><span class="cm-meta">: </span><span class="cm-variable-2">&amp;aws_configure</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  before_script</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>echo <span class="cm-string">"Configuring AWS credentials..."</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>apt-get update -y &amp;&amp; apt-get install -y awscli</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>aws configure set region $AWS_DEFAULT_REGION</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>echo <span class="cm-string">"AWS configuration complete."</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Define the stages</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">stages</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">  - </span>prepare</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">  - </span>validate</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">  - </span>synth</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">  - </span>diff</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">  - </span>deploy</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">default</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  image</span><span class="cm-meta">: </span>node<span class="cm-meta">:</span><span class="cm-number">18</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  tags</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>docker</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># --- Prepare Stage ---</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">install_deps</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  stage</span><span class="cm-meta">: </span>prepare</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  script</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>npm ci</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  cache</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  key</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp; &nbsp;  files</span><span class="cm-meta">: [</span>package-lock.json<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  paths</span><span class="cm-meta">: [</span>node_modules/<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  policy</span><span class="cm-meta">: </span>pull-push</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># --- Validate Stage ---</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">lint_code</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  stage</span><span class="cm-meta">: </span>validate</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  script</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>npm run lint</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  needs</span><span class="cm-meta">: [</span>install_deps<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  cache</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  key</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp; &nbsp;  files</span><span class="cm-meta">: [</span>package-lock.json<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  paths</span><span class="cm-meta">: [</span>node_modules/<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  policy</span><span class="cm-meta">: </span>pull</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">test_code</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  stage</span><span class="cm-meta">: </span>validate</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  script</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>npm run test</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  needs</span><span class="cm-meta">: [</span>install_deps<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  cache</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  key</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp; &nbsp;  files</span><span class="cm-meta">: [</span>package-lock.json<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  paths</span><span class="cm-meta">: [</span>node_modules/<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  policy</span><span class="cm-meta">: </span>pull</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># --- Synth Stage ---</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">synthesize_template</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  stage</span><span class="cm-meta">: </span>synth</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  &lt;&lt;</span><span class="cm-meta">: </span><span class="cm-variable-2">*aws_configure</span> <span class="cm-comment"># &lt;-- Use the anchor alias</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  script</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>npm run build</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>npx cdk synth MagicmailInfraStack</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  needs</span><span class="cm-meta">: [</span>install_deps<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  cache</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  key</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp; &nbsp;  files</span><span class="cm-meta">: [</span>package-lock.json<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  paths</span><span class="cm-meta">: [</span>node_modules/<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  policy</span><span class="cm-meta">: </span>pull</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  artifacts</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  paths</span><span class="cm-meta">: [</span>cdk.out/<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  expire_in</span><span class="cm-meta">: </span>1 day</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># --- Diff Stage ---</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">preview_changes</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  stage</span><span class="cm-meta">: </span>diff</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  &lt;&lt;</span><span class="cm-meta">: </span><span class="cm-variable-2">*aws_configure</span> <span class="cm-comment"># &lt;-- Use the anchor alias</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  script</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>npm run build</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>npx cdk diff MagicmailInfraStack</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  needs</span><span class="cm-meta">: [</span>install_deps<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  cache</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  key</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp; &nbsp;  files</span><span class="cm-meta">: [</span>package-lock.json<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  paths</span><span class="cm-meta">: [</span>node_modules/<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  policy</span><span class="cm-meta">: </span>pull</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># --- Deploy Stage ---</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">deploy_app</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  stage</span><span class="cm-meta">: </span>deploy</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  &lt;&lt;</span><span class="cm-meta">: </span><span class="cm-variable-2">*aws_configure</span> <span class="cm-comment"># &lt;-- Use the anchor alias</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  script</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>npm run build</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>echo <span class="cm-string">"Deploying CDK stack to AWS..."</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>npx cdk deploy MagicmailInfraStack --require-approval never</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  needs</span><span class="cm-meta">: [</span>preview_changes<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  cache</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  key</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp; &nbsp;  files</span><span class="cm-meta">: [</span>package-lock.json<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  paths</span><span class="cm-meta">: [</span>node_modules/<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  policy</span><span class="cm-meta">: </span>pull</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  rules</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span><span class="cm-atom">if</span><span class="cm-meta">: </span><span class="cm-string">'$CI_COMMIT_BRANCH == "main"'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp; &nbsp;  when</span><span class="cm-meta">: </span>manual</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp; &nbsp;  allow_failure</span><span class="cm-meta">: </span><span class="cm-keyword">false</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 2268px;"></div><div class="CodeMirror-gutters" style="display: none; height: 2268px;"></div></div></div></pre><p><span>&quot;This pipeline version is functionally identical but much cleaner.&quot;</span></p><p><strong><span>Committing and Running the Optimized Pipeline</span></strong>
<span>&quot;Save this optimized </span><code>.gitlab-ci.yml</code><span>.&quot;</span></p><p><span>&quot;Commit and push:&quot;</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.5px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Stage the changes</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> add .gitlab-ci.yml</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Commit the changes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> commit <span class="cm-attribute">-m</span> <span class="cm-string">"ci: Add diff and deploy stages, optimize AWS config"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Push the changes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> push origin main</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 168px;"></div><div class="CodeMirror-gutters" style="display: none; height: 168px;"></div></div></div></pre><p><span>&quot;Because you pushed to </span><code>main</code><span>, the full pipeline including the </span><code>deploy</code><span> stage will run.&quot;</span></p><ol start='' ><li><p><strong><span>Go to GitLab:</span></strong><span> Navigate to </span><strong><span>CI/CD -&gt; Pipelines</span></strong><span>.</span></p></li><li><p><strong><span>Observe:</span></strong><span> Watch the pipeline progress through all stages: </span><code>prepare</code><span>, </span><code>validate</code><span>, </span><code>synth</code><span>, and </span><code>diff</code><span>.</span></p></li><li><p><strong><span>Manual Trigger:</span></strong><span> Once the </span><code>diff</code><span> stage succeeds, the pipeline will pause. The </span><code>deploy_app</code><span> job in the </span><code>deploy</code><span> stage will show a &quot;play&quot; icon (manual trigger).</span></p></li></ol><p><span> </span><img src="images/book2-chap6-cicd-deploy-with-manual.png" referrerpolicy="no-referrer" alt="book2-chap6-cicd-deploy-with-manual">
<span>    </span><em><span>Caption: Pipeline paused, waiting for manual trigger on the deploy job.</span></em></p><ol start='4' ><li><p><strong><span>Review Diff (Optional but Recommended):</span></strong><span> Before triggering, click into the completed </span><code>preview_changes</code><span> job and review the </span><code>cdk diff</code><span> output in the log to confirm the expected changes.</span></p></li><li><p><strong><span>Trigger Deploy:</span></strong><span> Click the &quot;play&quot; icon next to the </span><code>deploy_app</code><span> job to manually start the deployment.</span></p></li><li><p><strong><span>Check Logs:</span></strong><span> Monitor the </span><code>deploy_app</code><span> job log to see the CloudFormation deployment progress.</span></p></li></ol><p><img src="images/book2-chap6-cicd-deploy-after-manual-approval.png" referrerpolicy="no-referrer" alt="book2-chap6-cicd-deploy-after-manual-approval">
<em><span>Caption: Job log showing successful execution of </span><code>cdk deploy</code><span> after manual trigger.</span></em></p><p><span>&quot;Success!&quot; Maya beamed. &quot;You&#39;ve now built a robust CI/CD pipeline with validation, preview, and a manual deployment gate for your CDK project. This provides a great balance of automation and control.&quot;</span></p><h2 id='tests-tests-and-more-tests'><span>Tests, Tests, and More Tests</span></h2><p><span>Maya tapped her screen and said, &quot;Now that we&#39;ve got our </span><code>synth</code><span> and </span><code>diff</code><span> jobs working, there are a couple more checks we can add — like running </span><code>cfn-lint</code><span> to verify the generated CloudFormation, and even </span><code>cdk-nag</code><span> for security and compliance.&quot;</span></p><p><span>Ethan blinked. &quot;Wait — more checks? Isn&#39;t </span><code>cdk synth</code><span> already enough?&quot;</span></p><p><span>Maya smiled. &quot;Not quite. Think of </span><code>cdk synth</code><span> as generating the blueprint, but it doesn’t always warn you if the blueprint is invalid. That’s where tools like </span><code>cfn-lint</code><span> come in.&quot;</span></p><p><span>Ethan leaned back in his chair. &quot;We’ve got </span><code>ESLint</code><span> and </span><code>Jest</code><span> in </span><code>validate</code><span>, then </span><code>cdk synth</code><span>, then </span><code>cdk diff</code><span>, and now possibly </span><code>cfn-lint</code><span> and </span><code>cdk-nag</code><span>? This is starting to feel like a lot.&quot;</span></p><p><span>Maya chuckled sympathetically. &quot;It’s totally fair to feel overwhelmed right now. But let’s step back and look at the big picture. Each of these tests plays a specific role — they&#39;re like </span><strong><span>different filters that catch different kinds of issues before we deploy anything</span></strong><span>. Let me show you a table that summarizes it all.&quot;</span></p><p><span>She opened her notebook and drew the following table:</span></p><figure class='table-figure'><table><thead><tr><th style='text-align:center;' ><span>Test / Tool</span></th><th style='text-align:center;' ><span>What It Tests</span></th><th style='text-align:center;' ><span>What It Tests Against</span></th><th style='text-align:center;' ><span>Stage</span></th><th style='text-align:center;' ><span>Prevents / Ensures</span></th></tr></thead><tbody><tr><td style='text-align:center;' ><code>eslint</code></td><td style='text-align:center;' ><span>Code style and syntax consistency</span></td><td style='text-align:center;' ><span>TypeScript source files</span></td><td style='text-align:center;' ><code>validate</code></td><td style='text-align:center;' ><span>Enforces readable, maintainable code</span></td></tr><tr><td style='text-align:center;' ><code>jest</code></td><td style='text-align:center;' ><span>Unit test behavior and correctness</span></td><td style='text-align:center;' ><span>TypeScript source files</span></td><td style='text-align:center;' ><code>validate</code></td><td style='text-align:center;' ><span>Verifies that logic behaves as expected</span></td></tr><tr><td style='text-align:center;' ><code>cdk synth</code></td><td style='text-align:center;' ><span>CDK-to-CloudFormation conversion</span></td><td style='text-align:center;' ><span>CDK code (compiled JavaScript)</span></td><td style='text-align:center;' ><code>synth</code></td><td style='text-align:center;' ><span>Ensures CDK code can produce a valid CloudFormation template</span></td></tr><tr><td style='text-align:center;' ><code>cfn-lint</code></td><td style='text-align:center;' ><span>Structural and semantic correctness of CFN</span></td><td style='text-align:center;' ><span>Synthesized template (</span><code>cdk.out/*.json</code><span>)</span></td><td style='text-align:center;' ><code>lint</code></td><td style='text-align:center;' ><span>Catches CloudFormation errors before deployment</span></td></tr><tr><td style='text-align:center;' ><code>cdk diff</code></td><td style='text-align:center;' ><span>Difference between generated and deployed stack</span></td><td style='text-align:center;' ><span>Current vs deployed CloudFormation stack</span></td><td style='text-align:center;' ><code>diff</code></td><td style='text-align:center;' ><span>Visualizes changes before apply for review and safety</span></td></tr><tr><td style='text-align:center;' ><code>cdk-nag</code><span> (optional)</span></td><td style='text-align:center;' ><span>Security and compliance rule violations</span></td><td style='text-align:center;' ><span>CDK constructs (via Aspects)</span></td><td style='text-align:center;' ><code>synth</code><span>*</span></td><td style='text-align:center;' ><span>Highlights insecure configurations or non-compliant infra</span></td></tr></tbody></table></figure><blockquote><p><span>*</span><code>cdk-nag</code><span> runs implicitly during </span><code>cdk synth</code><span> if configured using </span><code>Aspects</code><span>.</span></p></blockquote><p><span>Ethan nodded slowly. &quot;That actually helps a lot. I didn’t realize each tool was looking at a different part of the process.&quot;</span></p><p><span>Maya smiled. &quot;Exactly. And now that you see the big picture, let’s add another simple but powerful step — </span><code>cfn-lint</code><span>.&quot;</span></p><h3 id='adding-another-lint-stage-after-synth-with-cfn-lint'><span>Adding another lint Stage after synth with cfn-lint</span></h3><p><span>&quot;We’ve now synthesized our stack into a CloudFormation template in the </span><code>cdk.out</code><span> directory. But how do we know that the generated template is structurally valid? To catch issues early, we can run a tool called </span><code>cfn-lint</code><span> to validate the synthesized template before moving on to the </span><code>diff</code><span> and </span><code>deploy</code><span> stages.&quot;</span></p><p><span>&quot;</span><code>cfn-lint</code><span> checks the syntax, structure, and compliance of your CloudFormation templates — making sure things like property names and resource types are correct. It’s especially helpful for catching errors that CDK might allow at </span><em><span>synth-time</span></em><span> but that AWS CloudFormation would reject at </span><em><span>deploy-time</span></em><span>.&quot;</span></p><p><span>&quot;So add the lint stage to your </span><code>.gitlab-ci.yml</code><span> file and a corresponding </span><code>lint_cfn_template</code><span> job:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="yaml" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="yaml"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.5px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># .gitlab-ci.yml - Version 9 (Adding Lint Stage for cfn-lint After synth)</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Define reusable AWS credential configuration</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">.aws_configure_template</span><span class="cm-meta">: </span><span class="cm-variable-2">&amp;aws_configure</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  before_script</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>echo <span class="cm-string">"Configuring AWS credentials..."</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>apt-get update -y &amp;&amp; apt-get install -y awscli</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>aws configure set region $AWS_DEFAULT_REGION</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>echo <span class="cm-string">"AWS configuration complete."</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">stages</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">  - </span>prepare</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">  - </span>validate</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">  - </span>synth</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">  - </span>lint &nbsp; &nbsp;<span class="cm-comment"># &lt;-- NEW: Stage to validate synthesized CloudFormation template</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">  - </span>diff</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">  - </span>deploy</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">default</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  image</span><span class="cm-meta">: </span>node<span class="cm-meta">:</span><span class="cm-number">18</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  tags</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>docker</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># --- Prepare Stage ---</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">install_deps</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  stage</span><span class="cm-meta">: </span>prepare</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  script</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>npm ci</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  cache</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  key</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp; &nbsp;  files</span><span class="cm-meta">: [</span>package-lock.json<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  paths</span><span class="cm-meta">: [</span>node_modules/<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  policy</span><span class="cm-meta">: </span>pull-push</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># --- Validate Stage ---</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">lint_code</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  stage</span><span class="cm-meta">: </span>validate</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  script</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>npm run lint</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  needs</span><span class="cm-meta">: [</span>install_deps<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  cache</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  key</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp; &nbsp;  files</span><span class="cm-meta">: [</span>package-lock.json<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  paths</span><span class="cm-meta">: [</span>node_modules/<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  policy</span><span class="cm-meta">: </span>pull</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">test_code</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  stage</span><span class="cm-meta">: </span>validate</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  script</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>npm run test</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  needs</span><span class="cm-meta">: [</span>install_deps<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  cache</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  key</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp; &nbsp;  files</span><span class="cm-meta">: [</span>package-lock.json<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  paths</span><span class="cm-meta">: [</span>node_modules/<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  policy</span><span class="cm-meta">: </span>pull</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># --- Synth Stage ---</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">synthesize_template</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  stage</span><span class="cm-meta">: </span>synth</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  &lt;&lt;</span><span class="cm-meta">: </span><span class="cm-variable-2">*aws_configure</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  script</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>npm run build</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>npx cdk synth MagicmailInfraStack</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  needs</span><span class="cm-meta">: [</span>install_deps<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  cache</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  key</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp; &nbsp;  files</span><span class="cm-meta">: [</span>package-lock.json<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  paths</span><span class="cm-meta">: [</span>node_modules/<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  policy</span><span class="cm-meta">: </span>pull</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  artifacts</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  paths</span><span class="cm-meta">: [</span>cdk.out/<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  expire_in</span><span class="cm-meta">: </span>1 day</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># --- Lint Stage ---</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># This MUST come after synth, because it runs on the output of `cdk synth` (in cdk.out)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">lint_cfn_template</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  stage</span><span class="cm-meta">: </span>lint</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  &lt;&lt;</span><span class="cm-meta">: </span><span class="cm-variable-2">*aws_configure</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  script</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>echo <span class="cm-string">"Installing cfn-lint..."</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># The node:18 image does not include Python by default</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>apt-get update &amp;&amp; apt-get install -y python3 python3-pip</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>python3 -m pip install --break-system-packages cfn-lint</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>echo <span class="cm-string">"Validating CloudFormation template..."</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>cfn-lint cdk.out/MagicmailInfraStack.template.json</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  needs</span><span class="cm-meta">: [</span>synthesize_template<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  cache</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  key</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp; &nbsp;  files</span><span class="cm-meta">: [</span>package-lock.json<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  paths</span><span class="cm-meta">: [</span>node_modules/<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  policy</span><span class="cm-meta">: </span>pull</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># --- Diff Stage ---</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">preview_changes</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  stage</span><span class="cm-meta">: </span>diff</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  &lt;&lt;</span><span class="cm-meta">: </span><span class="cm-variable-2">*aws_configure</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  script</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>npm run build</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>npx cdk diff MagicmailInfraStack</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  needs</span><span class="cm-meta">: [</span>install_deps<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  cache</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  key</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp; &nbsp;  files</span><span class="cm-meta">: [</span>package-lock.json<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  paths</span><span class="cm-meta">: [</span>node_modules/<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  policy</span><span class="cm-meta">: </span>pull</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># --- Deploy Stage ---</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">deploy_app</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  stage</span><span class="cm-meta">: </span>deploy</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  &lt;&lt;</span><span class="cm-meta">: </span><span class="cm-variable-2">*aws_configure</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  script</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>npm run build</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span>npx cdk deploy MagicmailInfraStack --require-approval never</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  needs</span><span class="cm-meta">: [</span>preview_changes<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  cache</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  key</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp; &nbsp;  files</span><span class="cm-meta">: [</span>package-lock.json<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  paths</span><span class="cm-meta">: [</span>node_modules/<span class="cm-meta">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp;  policy</span><span class="cm-meta">: </span>pull</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom">  rules</span><span class="cm-meta">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta"> &nbsp;  - </span><span class="cm-atom">if</span><span class="cm-meta">: </span><span class="cm-string">'$CI_COMMIT_BRANCH == "main"'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp; &nbsp;  when</span><span class="cm-meta">: </span>manual</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-atom"> &nbsp; &nbsp;  allow_failure</span><span class="cm-meta">: </span><span class="cm-keyword">false</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 2667px;"></div><div class="CodeMirror-gutters" style="display: none; height: 2667px;"></div></div></div></pre><p><span>&quot;This job installs </span><code>cfn-lint</code><span> and runs it on the template that was generated by </span><code>cdk synth</code><span>. If the template is valid, the job will succeed. If there are any issues — such as a missing property or typo — the job will fail, preventing the pipeline from moving forward.&quot;</span></p><p><span>&quot;Ok. So are we goint to add cdk-nag too?  Security and compliance checks seem to be pretty important.&quot;</span></p><p><strong><span>Committing and Running the Updated Pipeline</span></strong>
<span>&quot;Save this updated </span><code>.gitlab-ci.yml</code><span>.&quot;</span></p><p><span>&quot;Commit and push:&quot;</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.5px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Stage the changes</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> add .gitlab-ci.yml</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Commit the changes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> commit <span class="cm-attribute">-m</span> <span class="cm-string">"ci: Addlint stage for cfn-lint"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Push the changes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> push origin main</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 168px;"></div><div class="CodeMirror-gutters" style="display: none; height: 168px;"></div></div></div></pre><p><span>&quot;This job installs </span><code>cfn-lint</code><span> and runs it on the template that was generated by </span><code>cdk synth</code><span>. If the template is valid, the job will succeed. If there are any issues — such as a missing property or typo — the job will fail, preventing the pipeline from moving forward.</span></p><p><img src="images/book2-chap6-cicd-cfn-lint-error.png" referrerpolicy="no-referrer" alt="book2-chap6-cicd-cfn-lint-error">
<em><span>Caption: Job log showing cfn-lint warning, and successful execution of </span><code>cdk deploy</code><span> after manual trigger.</span></em></p><p><span>Ethan watched as the pipeline moved forward anyway. &quot;Interesting... even though </span><code>cfn-lint</code><span> flagged a warning, the </span><code>diff</code><span> stage still ran — and I was able to trigger the deploy manually.&quot;</span></p><p><span>Maya nodded. &quot;That&#39;s a great observation. Warnings don&#39;t always block the pipeline unless we configure them to. But they’re still important clues. In this case, the warning was about an </span><em><span>unnecessary dependency in your synthesized CloudFormation template</span></em><span>. It’s not fatal, but it might indicate something you could clean up.&quot;</span></p><p><span>She continued, &quot;I’d recommend looking into that warning when you have time — it could lead to a useful refactor of how your stack manages resources. It’s the kind of thing that’ll make your infrastructure cleaner and more maintainable over time.&quot;</span></p><h3 id='nag-or-not-to-nag'><span>Nag or Not To Nag</span></h3><p><span>Ethan tilted his head. &quot;Okay... so are we going to add </span><code>cdk-nag</code><span> too? I mean, security and compliance checks seem pretty important, especially if we’re working toward production-ready infrastructure.&quot;</span></p><p><span>Maya nodded. &quot;You&#39;re absolutely right — </span><code>cdk-nag</code><span> is a powerful tool for security and compliance checks. The only catch is, it integrates into the CDK using a feature called </span><code>Aspects</code><span>, which allows rule engines to traverse the construct tree during </span><code>cdk synth</code><span>. We intentionally skipped the topic of </span><code>Aspects</code><span> in Book 1 to keep things focused and beginner-friendly. If you&#39;re curious, we&#39;ll cover it more thoroughly in a future book when we explore more advanced CDK patterns.&quot;</span></p><p><span>She leaned over her laptop. &quot;But for a curious mind like yours, Ethan, here’s a sneak peek:&quot;</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="typescript"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="typescript"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.5px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> { <span class="cm-def">AwsSolutionsChecks</span> } <span class="cm-keyword">from</span> <span class="cm-string">'cdk-nag'</span>;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> { <span class="cm-def">Aspects</span> } <span class="cm-keyword">from</span> <span class="cm-string">'aws-cdk-lib'</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Aspects</span>.<span class="cm-property">of</span>(<span class="cm-variable">app</span>).<span class="cm-property">add</span>(<span class="cm-keyword">new</span> <span class="cm-variable">AwsSolutionsChecks</span>());</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 84px;"></div><div class="CodeMirror-gutters" style="display: none; height: 84px;"></div></div></div></pre><p><span>With this setup, security violations will be printed automatically during </span><code>cdk synth</code><span>. Since </span><code>Aspects</code><span> are a new topic to you, we will skip this for now and revisit it later.</span></p><h2 id='seeing-the-total-testing-flow-in-the-pipeline'><span>Seeing the Total Testing Flow in the Pipeline</span></h2><p><span>Ethan leaned back, eyes wide. “Okay, that’s a lot. But also... kind of awesome.”</span></p><p><span>Maya laughed. “It is, isn’t it? Think about it — we’re now validating code quality, testing functionality, converting our CDK to CloudFormation, linting it, checking what would change, and even staging deployment with manual approval.”</span></p><p><span>She opened her laptop and rotated it toward Ethan. “Let me show you how all of that fits together in one visual. It’s easier to see the flow when it’s laid out.”</span></p><p><span>Ethan nodded. “Yeah — I’d love to see the whole thing mapped out.”</span></p><div class="md-diagram-panel md-fences-adv-panel" lang="mermaid"><svg id="mermaidChart105" width="100%" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" class="flowchart mermaid-svg" style="max-width: 386px;" viewBox="-8 -8 386 1563.953125" role="graphics-document document" aria-roledescription="flowchart-v2"><style>#mermaidChart105{font-family:sans-serif;font-size:16px;fill:#333;}#mermaidChart105 .error-icon{fill:#552222;}#mermaidChart105 .error-text{fill:#552222;stroke:#552222;}#mermaidChart105 .edge-thickness-normal{stroke-width:1px;}#mermaidChart105 .edge-thickness-thick{stroke-width:3.5px;}#mermaidChart105 .edge-pattern-solid{stroke-dasharray:0;}#mermaidChart105 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaidChart105 .edge-pattern-dashed{stroke-dasharray:3;}#mermaidChart105 .edge-pattern-dotted{stroke-dasharray:2;}#mermaidChart105 .marker{fill:#333333;stroke:#333333;}#mermaidChart105 .marker.cross{stroke:#333333;}#mermaidChart105 svg{font-family:sans-serif;font-size:16px;}#mermaidChart105 p{margin:0;}#mermaidChart105 .label{font-family:sans-serif;color:#333;}#mermaidChart105 .cluster-label text{fill:#333;}#mermaidChart105 .cluster-label span{color:#333;}#mermaidChart105 .cluster-label span p{background-color:transparent;}#mermaidChart105 .label text,#mermaidChart105 span{fill:#333;color:#333;}#mermaidChart105 .node rect,#mermaidChart105 .node circle,#mermaidChart105 .node ellipse,#mermaidChart105 .node polygon,#mermaidChart105 .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaidChart105 .rough-node .label text,#mermaidChart105 .node .label text,#mermaidChart105 .image-shape .label,#mermaidChart105 .icon-shape .label{text-anchor:middle;}#mermaidChart105 .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#mermaidChart105 .rough-node .label,#mermaidChart105 .node .label,#mermaidChart105 .image-shape .label,#mermaidChart105 .icon-shape .label{text-align:center;}#mermaidChart105 .node.clickable{cursor:pointer;}#mermaidChart105 .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#mermaidChart105 .arrowheadPath{fill:#333333;}#mermaidChart105 .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaidChart105 .flowchart-link{stroke:#333333;fill:none;}#mermaidChart105 .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#mermaidChart105 .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#mermaidChart105 .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#mermaidChart105 .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#mermaidChart105 .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaidChart105 .cluster text{fill:#333;}#mermaidChart105 .cluster span{color:#333;}#mermaidChart105 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaidChart105 .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#mermaidChart105 rect.text{fill:none;stroke-width:0;}#mermaidChart105 .icon-shape,#mermaidChart105 .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#mermaidChart105 .icon-shape p,#mermaidChart105 .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#mermaidChart105 .icon-shape rect,#mermaidChart105 .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#mermaidChart105 :root{--mermaid-alt-font-family:sans-serif;}</style><g><marker id="mermaidChart105_flowchart-v2-pointEnd" class="marker flowchart-v2" viewBox="0 0 10 10" refX="5" refY="5" markerUnits="userSpaceOnUse" markerWidth="8" markerHeight="8" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowMarkerPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker><marker id="mermaidChart105_flowchart-v2-pointStart" class="marker flowchart-v2" viewBox="0 0 10 10" refX="4.5" refY="5" markerUnits="userSpaceOnUse" markerWidth="8" markerHeight="8" orient="auto"><path d="M 0 5 L 10 10 L 10 0 z" class="arrowMarkerPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker><marker id="mermaidChart105_flowchart-v2-circleEnd" class="marker flowchart-v2" viewBox="0 0 10 10" refX="11" refY="5" markerUnits="userSpaceOnUse" markerWidth="11" markerHeight="11" orient="auto"><circle cx="5" cy="5" r="5" class="arrowMarkerPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></circle></marker><marker id="mermaidChart105_flowchart-v2-circleStart" class="marker flowchart-v2" viewBox="0 0 10 10" refX="-1" refY="5" markerUnits="userSpaceOnUse" markerWidth="11" markerHeight="11" orient="auto"><circle cx="5" cy="5" r="5" class="arrowMarkerPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></circle></marker><marker id="mermaidChart105_flowchart-v2-crossEnd" class="marker cross flowchart-v2" viewBox="0 0 11 11" refX="12" refY="5.2" markerUnits="userSpaceOnUse" markerWidth="11" markerHeight="11" orient="auto"><path d="M 1,1 l 9,9 M 10,1 l -9,9" class="arrowMarkerPath" style="stroke-width: 2; stroke-dasharray: 1, 0;"></path></marker><marker id="mermaidChart105_flowchart-v2-crossStart" class="marker cross flowchart-v2" viewBox="0 0 11 11" refX="-1" refY="5.2" markerUnits="userSpaceOnUse" markerWidth="11" markerHeight="11" orient="auto"><path d="M 1,1 l 9,9 M 10,1 l -9,9" class="arrowMarkerPath" style="stroke-width: 2; stroke-dasharray: 1, 0;"></path></marker><g class="root"><g class="clusters"></g><g class="edgePaths"></g><g class="edgeLabels"></g><g class="nodes"><g class="root" transform="translate(0, 0)"><g class="clusters"><g class="cluster " id="subGraph0" data-look="classic"><rect style="" x="8" y="8" width="362" height="1539.953125"></rect><g class="cluster-label " transform="translate(111.2109375, 8)"><foreignObject width="155.578125" height="31"><div xmlns="http://www.w3.org/1999/xhtml" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="nodeLabel "><p>CI/CD Pipeline Flow</p></span></div></foreignObject></g></g></g><g class="edgePaths"><path d="M189,137.5L189,143.75C189,150,189,162.5,189,174.333C189,186.167,189,197.333,189,202.917L189,208.5" id="L_P_V_0" class=" edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style="" marker-end="url(#mermaidChart105_flowchart-v2-pointEnd)"></path><path d="M189,304.5L189,310.75C189,317,189,329.5,189,341.333C189,353.167,189,364.333,189,369.917L189,375.5" id="L_V_S_1" class=" edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style="" marker-end="url(#mermaidChart105_flowchart-v2-pointEnd)"></path><path d="M189,471.5L189,477.75C189,484,189,496.5,189,508.333C189,520.167,189,531.333,189,536.917L189,542.5" id="L_S_L_2" class=" edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style="" marker-end="url(#mermaidChart105_flowchart-v2-pointEnd)"></path><path d="M189,607.5L189,613.75C189,620,189,632.5,189,644.333C189,656.167,189,667.333,189,672.917L189,678.5" id="L_L_D_3" class=" edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style="" marker-end="url(#mermaidChart105_flowchart-v2-pointEnd)"></path><path d="M189,743.5L189,749.75C189,756,189,768.5,189.075,780.417C189.149,792.333,189.298,803.667,189.373,809.334L189.447,815" id="L_D_M_4" class=" edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style="" marker-end="url(#mermaidChart105_flowchart-v2-pointEnd)"></path><path d="M189.5,1111L189.417,1117.167C189.333,1123.333,189.167,1135.667,189.083,1147.417C189,1159.167,189,1170.333,189,1175.917L189,1181.5" id="L_M_DEP_5" class=" edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style="" marker-end="url(#mermaidChart105_flowchart-v2-pointEnd)"></path><path d="M189,1277.5L189,1283.75C189,1290,189,1302.5,189,1314.333C189,1326.167,189,1337.333,189,1342.917L189,1348.5" id="L_DEP_DONE_6" class=" edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" style="" marker-end="url(#mermaidChart105_flowchart-v2-pointEnd)"></path></g><g class="edgeLabels"><g class="edgeLabel"><g class="label" transform="translate(0, 0)"><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel "></span></div></foreignObject></g></g><g class="edgeLabel"><g class="label" transform="translate(0, 0)"><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel "></span></div></foreignObject></g></g><g class="edgeLabel"><g class="label" transform="translate(0, 0)"><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel "></span></div></foreignObject></g></g><g class="edgeLabel"><g class="label" transform="translate(0, 0)"><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel "></span></div></foreignObject></g></g><g class="edgeLabel"><g class="label" transform="translate(0, 0)"><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel "></span></div></foreignObject></g></g><g class="edgeLabel"><g class="label" transform="translate(0, 0)"><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel "></span></div></foreignObject></g></g><g class="edgeLabel"><g class="label" transform="translate(0, 0)"><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="edgeLabel "></span></div></foreignObject></g></g></g><g class="nodes"><g class="node default  " id="flowchart-P-1448" transform="translate(189, 91.5)"><rect class="basic label-container" style="fill:#e2e2e2 !important;stroke:#333 !important" x="-130" y="-46" width="260" height="92"></rect><g class="label" style="" transform="translate(-100, -31)"><rect></rect><foreignObject width="200" height="62"><div xmlns="http://www.w3.org/1999/xhtml" style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;"><span class="nodeLabel "><p>Prepare Stage install_deps</p></span></div></foreignObject></g></g><g class="node default  " id="flowchart-V-1449" transform="translate(189, 258.5)"><rect class="basic label-container" style="fill:#b3d9ff !important;stroke:#333 !important" x="-130" y="-46" width="260" height="92"></rect><g class="label" style="" transform="translate(-100, -31)"><rect></rect><foreignObject width="200" height="62"><div xmlns="http://www.w3.org/1999/xhtml" style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;"><span class="nodeLabel "><p>Validate Stage ESLint and Jest</p></span></div></foreignObject></g></g><g class="node default  " id="flowchart-S-1450" transform="translate(189, 425.5)"><rect class="basic label-container" style="fill:#b2f0b2 !important;stroke:#333 !important" x="-130" y="-46" width="260" height="92"></rect><g class="label" style="" transform="translate(-100, -31)"><rect></rect><foreignObject width="200" height="62"><div xmlns="http://www.w3.org/1999/xhtml" style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;"><span class="nodeLabel "><p>Synth Stage cdk_synth and cdk_nag</p></span></div></foreignObject></g></g><g class="node default  " id="flowchart-L-1451" transform="translate(189, 577)"><rect class="basic label-container" style="fill:#fff0b3 !important;stroke:#333 !important" x="-99.546875" y="-30.5" width="199.09375" height="61"></rect><g class="label" style="" transform="translate(-69.546875, -15.5)"><rect></rect><foreignObject width="139.09375" height="31"><div xmlns="http://www.w3.org/1999/xhtml" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="nodeLabel "><p>Lint Stage cfn_lint</p></span></div></foreignObject></g></g><g class="node default  " id="flowchart-D-1452" transform="translate(189, 713)"><rect class="basic label-container" style="fill:#ffc285 !important;stroke:#333 !important" x="-101.6484375" y="-30.5" width="203.296875" height="61"></rect><g class="label" style="" transform="translate(-71.6484375, -15.5)"><rect></rect><foreignObject width="143.296875" height="31"><div xmlns="http://www.w3.org/1999/xhtml" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="nodeLabel "><p>Diff Stage cdk_diff</p></span></div></foreignObject></g></g><g class="node default  " id="flowchart-M-1453" transform="translate(189, 964.5)"><polygon points="146,0 292,-146 146,-292 0,-146" class="label-container" transform="translate(-146,146)" style="fill:#fdd0ff !important;stroke:#333 !important;stroke-dasharray:5 5 !important"></polygon><g class="label" style="" transform="translate(-100, -31)"><rect></rect><foreignObject width="200" height="62"><div xmlns="http://www.w3.org/1999/xhtml" style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;"><span class="nodeLabel "><p>Manual Approval for Deploy</p></span></div></foreignObject></g></g><g class="node default  " id="flowchart-DEP-1454" transform="translate(189, 1231.5)"><rect class="basic label-container" style="fill:#d9ccff !important;stroke:#333 !important" x="-130" y="-46" width="260" height="92"></rect><g class="label" style="" transform="translate(-100, -31)"><rect></rect><foreignObject width="200" height="62"><div xmlns="http://www.w3.org/1999/xhtml" style="display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;"><span class="nodeLabel "><p>Deploy Stage cdk_deploy</p></span></div></foreignObject></g></g><g class="node default  " id="flowchart-DONE-1455" transform="translate(189, 1431.4765625)"><circle class="basic label-container" style="fill:#ccc !important;stroke:#333 !important" r="78.9765625" cx="0" cy="0"></circle><g class="label" style="" transform="translate(-71.4765625, -15.5)"><rect></rect><foreignObject width="142.953125" height="31"><div xmlns="http://www.w3.org/1999/xhtml" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;"><span class="nodeLabel "><p>Pipeline Complete</p></span></div></foreignObject></g></g></g></g></g></g></g></svg></div><h2 id='tagging-the-end-of-chapter-6'><span>Tagging the End of Chapter 6</span></h2><p><span>&quot;Ok. Today was a good session with a lot of learnings. Let&#39;s tag the end of Chapter 6 to mark the completion of our first full CI/CD pipeline,&quot; said Maya.</span></p><ol start='' ><li><p><span>Ensure main is Up-to-Date: Make sure you are on the main branch locally and have pulled the latest changes:</span></p></li></ol><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.5px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> switch main</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> pull origin main</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 42px;"></div><div class="CodeMirror-gutters" style="display: none; height: 42px;"></div></div></div></pre><ol start='2' ><li><p><span>Create Local Tag: Create the tag pointing to the latest commit on main:</span></p></li></ol><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.5px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> tag chapter-6-end</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 21px;"></div><div class="CodeMirror-gutters" style="display: none; height: 21px;"></div></div></div></pre><ol start='3' ><li><p><span>Push Tag: Push this new tag to the remote GitLab server (origin):</span></p></li></ol><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="bash"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 8.5px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: currentcolor;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: currentcolor;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> push origin chapter-6-end</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 21px;"></div><div class="CodeMirror-gutters" style="display: none; height: 21px;"></div></div></div></pre><p><span>&quot;Fantastic! We now have tags marking the end of each chapter, making it easy to navigate the project&#39;s history.&quot;</span></p><h2 id='wrapping-up-chapter-6'><span>Wrapping Up Chapter 6</span></h2><p><span>&quot;A huge accomplishment today, Ethan,&quot; Maya said warmly. &quot;You&#39;ve taken your pipeline beyond code validation — now it securely connects to AWS, synthesizes infrastructure, previews changes with cdk diff, and stages safe deployments with manual approval.&quot;</span></p><p><span>&quot;You&#39;ve built a full, professional-grade CI/CD system for your infrastructure — with the right balance of automation and control.&quot;</span></p><p><span>Maya nodded. &quot;While there&#39;s always more you can explore — like security scanning, multi-environment deployments, and compliance checks — the skills you&#39;ve built here are the backbone of real-world DevOps practices.&quot;</span></p><p><span>&quot;Congratulations, Ethan. You&#39;re ready to tackle even larger cloud systems — safely, reliably, and at scale.&quot;</span></p><hr /><h2 id='ethans-homework'><span>Ethan&#39;s Homework</span></h2><blockquote><ul><li><p><strong><span>Explore </span><code>rules:when</code><span>:</span></strong><span> Read the GitLab CI/CD documentation about the </span><code>rules:if:when</code><span> keyword, specifically the difference between </span><code>on_success</code><span>, </span><code>manual</code><span>, and </span><code>delayed</code><span>.</span></p></li><li><p><strong><span>Protected Branches:</span></strong><span> Explore GitLab project settings (Settings -&gt; Repository -&gt; Protected branches) to understand how the </span><code>main</code><span> branch is typically protected and how CI/CD variable protection interacts with this.</span></p></li><li><p><strong><span>Trigger a Change:</span></strong><span> Make a small, safe change to your </span><code>MagicmailInfraStack</code><span> (e.g., add another tag to the S3 bucket). Commit and push to </span><code>main</code><span>. Observe the pipeline run, review the </span><code>cdk diff</code><span> output in the </span><code>preview_changes</code><span> job, and then manually trigger the </span><code>deploy_app</code><span>job to apply the change.</span></p></li></ul></blockquote><h2 id='key-takeaways'><span>Key Takeaways</span></h2><blockquote><ul><li><p><span>Securely managing AWS credentials in CI/CD is crucial; avoid hardcoding keys.</span></p></li><li><p><span>GitLab CI/CD Variables provide a secure way to store credentials (</span><code>AWS_ACCESS_KEY_ID</code><span>, </span><code>AWS_SECRET_ACCESS_KEY</code><span>, </span><code>AWS_DEFAULT_REGION</code><span>). Use </span><strong><span>Protected</span></strong><span> and </span><strong><span>Masked</span></strong><span> flags for sensitive values.</span></p></li><li><p><span>Jobs needing AWS access require configuration (e.g., using </span><code>aws configure</code><span> in a </span><code>before_script</code><span>) to use the injected variables.</span></p></li><li><p><span>YAML Anchors (</span><code>&amp;</code><span>) and Aliases (</span><code>*</code><span>) help keep </span><code>.gitlab-ci.yml</code><span> DRY by defining reusable configuration blocks (like </span><code>before_script</code><span>).</span></p></li><li><p><span>Adding a </span><code>cdk synth</code><span> job to the pipeline validates template synthesis and performs context lookups. Saving </span><code>cdk.out</code><span> as artifacts can be useful for subsequent stages.</span></p></li><li><p><span>Adding a </span><code>cdk diff</code><span> job provides a crucial preview of infrastructure changes before deployment.</span></p></li><li><p><span>Adding a </span><code>cdk deploy --require-approval never</code><span> job automates the deployment.</span></p></li><li><p><span>Using </span><code>rules:if:when: manual</code><span> creates a </span><strong><span>manual approval gate</span></strong><span>, pausing the pipeline before deployment until a user explicitly triggers the deploy job. This adds a layer of safety, especially for production environments.</span></p></li></ul></blockquote><h2 id='looking-ahead'><span>Looking Ahead</span></h2><p><span>Congratulations! You&#39;ve successfully built a multi-stage CI/CD pipeline that automates the validation, synthesis, preview, and deployment (with manual approval) of your CDK infrastructure code using GitLab. This setup significantly improves consistency, safety, and efficiency compared to manual deployments.</span></p><p><span>Book 3 will be the start of designing and implementing shared services for MagicMail which also incorporates microservices design. Maya will guide Ethan through designing a microservices architecture for MagicMail. They&#39;ll identify core services, define boundaries and communication patterns, and plan how to structure their CDK application to implement this architecture effectively.</span></p><h2 id='key-services--concepts-introduced'><span>Key Services &amp; Concepts Introduced</span></h2><h3 id='aws-services'><span>AWS Services:</span></h3><blockquote><ul><li><p><strong><span>IAM:</span></strong><span> Creating a dedicated user for CI/CD (though needing better permissions than AdministratorAccess in production).</span></p></li><li><p><strong><span>CloudFormation:</span></strong><span> Synthesized from CDK, validated with </span><code>cfn-lint</code><span>, and deployed via </span><code>cdk deploy</code><span>.</span></p></li></ul></blockquote><h3 id='gitlab-features'><span>GitLab Features:</span></h3><blockquote><ul><li><p><strong><span>CI/CD Variables:</span></strong><span> Storing </span><code>AWS_ACCESS_KEY_ID</code><span>, </span><code>AWS_SECRET_ACCESS_KEY</code><span>, </span><code>AWS_DEFAULT_REGION</code><span> securely. Using Protected and Masked flags.</span></p></li><li><p><strong><code>.gitlab-ci.yml</code><span>:</span></strong></p><ul><li><p><span>Defining </span><code>stages</code></p></li><li><p><span>Using </span><code>before_script</code><span>, </span><code>artifacts</code><span>, </span><code>needs</code><span>, and </span><code>cache</code></p></li><li><p><span>Leveraging </span><code>rules:if:when: manual</code><span> for controlled deployment</span></p></li><li><p><span>Defining YAML anchors (</span><code>&amp;</code><span>) and aliases (</span><code>*</code><span>) to reduce duplication.</span></p></li></ul></li><li><p><strong><span>Manual Jobs:</span></strong><span> Understanding and triggering jobs set to </span><code>when: manual</code><span>.</span></p></li></ul></blockquote><h3 id='tools--concepts'><span>Tools &amp; Concepts:</span></h3><blockquote><ul><li><p><code>eslint</code><span>: Enforces code quality and formatting.</span></p></li><li><p><code>jest</code><span>: Runs unit tests to verify application behavior.</span></p></li><li><p><code>cdk synth</code><span>: Transforms CDK code to CloudFormation; enables context lookups.</span></p></li><li><p><code>cfn-lint</code><span>: Validates synthesized CloudFormation templates for structure and syntax.</span></p></li><li><p><code>cdk diff</code><span>: Shows proposed changes compared to existing infrastructure.</span></p></li><li><p><code>cdk deploy --require-approval never</code><span>: Automates stack deployment.</span></p></li><li><p><code>cdk-nag (optional)</code><span>: Adds security and compliance checks using CDK Aspects.</span></p></li><li><p><code>Aspects (preview only)</code><span>: Mechanism to apply global checks like cdk-nag.</span></p></li><li><p><code>DRY Pipelines</code><span>: Avoiding repetition using YAML reuse patterns.</span></p></li><li><p><code>CI/CD Flow Design</code><span>: Understanding the purpose and order of pipeline stages.</span></p></li></ul></blockquote></div></div>
</body>
</html>